<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HelpDesk TI</title>
    
    <script>
        (function() {
            const iconSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='112' fill='%232563eb'/><rect x='116' y='146' width='280' height='220' rx='24' fill='none' stroke='white' stroke-width='32'/><line x1='176' y1='416' x2='336' y2='416' stroke='white' stroke-width='32' stroke-linecap='round'/><line x1='256' y1='366' x2='256' y2='416' stroke='white' stroke-width='32'/><path d='M216 266 l 24 24 l 56 -56' stroke='white' stroke-width='32' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>`;
            const iconUrl = "data:image/svg+xml;charset=utf-8," + iconSvg.replace(/"/g, "'");
            const linkFavicon = document.createElement('link'); linkFavicon.rel = 'icon'; linkFavicon.href = iconUrl; linkFavicon.type = 'image/svg+xml'; document.head.appendChild(linkFavicon);
            const linkAppleTouch = document.createElement('link'); linkAppleTouch.rel = 'apple-touch-icon'; linkAppleTouch.href = iconUrl; document.head.appendChild(linkAppleTouch);
            const manifest = { name: "HelpDesk TI", short_name: "HelpDesk", description: "Sistema de Controle de Chamados e Inventário", start_url: "./", display: "standalone", background_color: "#f8fafc", theme_color: "#2563eb", orientation: "portrait", icons: [{ src: iconUrl, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" }, { src: iconUrl, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }] };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const linkManifest = document.createElement('link'); linkManifest.rel = 'manifest'; linkManifest.href = URL.createObjectURL(manifestBlob); document.head.appendChild(linkManifest);
            const swCode = `self.addEventListener('install', (e) => { self.skipWaiting(); }); self.addEventListener('activate', (e) => { e.waitUntil(clients.claim()); }); self.addEventListener('fetch', (e) => { });`;
            const swUrl = URL.createObjectURL(new Blob([swCode], {type: 'text/javascript'}));
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register(swUrl).catch(err => console.warn('PWA SW falhou', err)); }); }
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Previne o erro "tailwind is not defined" em caso de carregamento assíncrono
        if (typeof tailwind !== 'undefined') {
            tailwind.config = { darkMode: 'class' };
        } else {
            window.tailwind = { config: { darkMode: 'class' } };
        }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            PlusCircle, CheckCircle, Clock, User, Settings, AlertCircle, Search, ClipboardList, Lock, LogOut, Sun, Moon,
            MessageSquare, Send, MessageCircle, Monitor, Hash, Laptop, Bell, Volume2, VolumeX, UserCheck, Archive, History, Calendar,
            Building2, ChevronDown, Check, ArrowUpCircle, EyeOff, UserPlus, StickyNote, Users, MapPin, X, ChevronRight, ChevronLeft, AlignLeft,
            AlertTriangle, RotateCcw, UserMinus, ShieldAlert, BarChart3, Filter, FileText, Image as ImageIcon, Paperclip, Wrench, Edit, Trash2,
            PackagePlus, Plus, Minus, Maximize2, Layers, Download, AlertOctagon, Terminal, Database, Smartphone, Mouse, Keyboard, Headphones, Cpu,
            HardDrive, ArrowLeftRight, ArchiveRestore, Kanban, BookOpen, ListTodo, CheckSquare, Repeat, Circle
        } from 'lucide-react';
        import { initializeApp, getApps, getApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, arrayUnion, deleteDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'firebase/auth';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';

        const customScrollStyles = `
            ::-webkit-scrollbar { width: 10px; }
            ::-webkit-scrollbar-track { background: var(--scrollbar-track, #f8fafc); }
            ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb, #cbd5e1); border-radius: 20px; border: 3px solid var(--scrollbar-track, #f8fafc); }
            ::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-hover, #94a3b8); }
            * { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb, #cbd5e1) var(--scrollbar-track, #f8fafc); }
            input[type="date"] { position: relative; }
            input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        `;

        const firebaseConfig = {
            apiKey: "AIzaSyBKY87Q4ovUqKlRTZU4b-BLdGebqZQrWuM",
            authDomain: "evs-systems.firebaseapp.com",
            projectId: "evs-systems",
            storageBucket: "evs-systems.firebasestorage.app",
            messagingSenderId: "150565801535",
            appId: "1:150565801535:web:3cb64a89beaa728131328a",
            measurementId: "G-23NE5WCHR5"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const SOUND_NEW_TICKET = "https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"; 
        const SOUND_UPDATE = "https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"; 
        const EMAIL_DOMAIN = "@helpdeskti.com";

        const STATUS_OPTIONS = [
            { id: 'aguardando', label: 'Aguardando', color: 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-500 dark:border-yellow-800', icon: Clock },
            { id: 'atendimento', label: 'Em atendimento', color: 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800', icon: User },
            { id: 'autorizacao', label: 'Aguardando autorização', color: 'bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-400 dark:border-blue-800', icon: Settings },
            { id: 'contestado', label: 'Contestado', color: 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-500 dark:border-red-800', icon: AlertTriangle },
            { id: 'finalizado', label: 'Finalizado', color: 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800', icon: CheckCircle },
        ];

        const PRIORITY_OPTIONS = [
            { id: 'baixa', label: 'Baixa', color: 'bg-slate-100 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700', icon: CheckCircle },
            { id: 'media', label: 'Média', color: 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-500 dark:border-orange-800', icon: AlertCircle },
            { id: 'alta', label: 'Alta', color: 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800', icon: AlertCircle },
        ];

        const UNIT_QUICK_FILTERS = ["Bonway", "Everest", "EverSky", "Perus", "Barueri", "Good"];

        const MOTIVATIONAL_PHRASES = ["A tecnologia move o mundo, e você move a tecnologia.", "Cada problema resolvido é um passo para a excelência.", "Seu trabalho conecta pessoas e solutions.", "Grandes realizações são feitas de pequenos detalhes bem resolvidos.", "Hoje é um ótimo dia para fazer a diferença!", "A persistência é o caminho do êxito.", "Solucionar é simplificar o complexo.", "Sua dedicação transforma desafios em oportunidades."];

        const generateTimeOptions = () => {
            const options = ["A Qualquer Momento"];
            let startHour = 8; let startMinute = 30;
            while (startHour < 17 || (startHour === 17 && startMinute <= 30)) {
                options.push(`${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`);
                startMinute += 30;
                if (startMinute >= 60) { startMinute = 0; startHour += 1; }
            }
            return options;
        };

        const TIME_OPTIONS = generateTimeOptions();
        const EQUIPMENT_TYPES = ["Notebook", "Desktop", "Monitor", "Celular", "Tablet", "Impressora", "Nobreak", "Switch/Roteador", "Outros"];
        const ACCESSORY_TYPES = ["Mouse", "Teclado", "Suporte", "Fones", "Capinha Celular", "Película", "Cabo", "Carregador", "Outros"];

        const KANBAN_COLUMNS = [
            { id: 'todo', title: 'A Fazer', color: 'text-blue-600 dark:text-blue-400 bg-blue-100/50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800' },
            { id: 'doing', title: 'Em Andamento', color: 'text-orange-600 dark:text-orange-400 bg-orange-100/50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800' },
            { id: 'review', title: 'Em Revisão', color: 'text-purple-600 dark:text-purple-400 bg-purple-100/50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800' },
            { id: 'done', title: 'Concluído', color: 'text-green-600 dark:text-green-400 bg-green-100/50 dark:bg-green-900/20 border-green-200 dark:border-green-800' }
        ];

        const formatName = (name) => {
            if (!name) return "";
            return String(name).toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };

        const formatDisplay = (text) => {
            if (!text) return "Pendente";
            let clean = String(text).trim().toLowerCase();
            const dictionary = { "gerencia": "Gerência", "ti": "TI", "rh": "RH", "manutencao": "Manutenção", "producao": "Produção" };
            if (dictionary[clean]) return dictionary[clean];
            return clean.charAt(0).toUpperCase() + clean.slice(1);
        };

        const normalizeSearch = (text) => {
            if (!text) return "";
            return String(text).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().replace(/\s+/g, " ");
        };

        const formatDateBr = (dateString) => {
            if (!dateString) return 'Selecione';
            if (String(dateString).includes('/')) return dateString;
            const parts = String(dateString).split('-');
            if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            return dateString;
        };

        const formatCurrency = (value) => {
            const numericValue = parseFloat(value) || 0;
            return numericValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '...';
            try {
                if (timestamp?.toDate && typeof timestamp.toDate === 'function') return timestamp.toDate().toLocaleString();
                if (timestamp?.seconds) return new Date(timestamp.seconds * 1000).toLocaleString();
                if (typeof timestamp === 'string') {
                    const d = new Date(timestamp);
                    if(!isNaN(d.getTime())) return d.toLocaleString();
                    return timestamp;
                }
                if (timestamp instanceof Date) return timestamp.toLocaleString();
                return '...';
            } catch (e) { return '...'; }
        };

        const MONTHS = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const ImageViewer = ({ isOpen, onClose, images, currentIndex, onNext, onPrev }) => {
            const [zoom, setZoom] = useState(1);
            const [isDragging, setIsDragging] = useState(false);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const startPos = useRef({ x: 0, y: 0 });

            useEffect(() => { if (isOpen) { setZoom(1); setPosition({ x: 0, y: 0 }); } }, [isOpen, currentIndex]);

            if (!isOpen || images.length === 0) return null;
            const currentImage = images[currentIndex];

            const handleMouseDown = (e) => { if (zoom > 1) { setIsDragging(true); startPos.current = { x: e.clientX - position.x, y: e.clientY - position.y }; } };
            const handleMouseMove = (e) => { if (isDragging) { setPosition({ x: e.clientX - startPos.current.x, y: e.clientY - startPos.current.y }); } };
            const handleMouseUp = () => setIsDragging(false);

            return (
                <div className="fixed inset-0 z-[80] bg-black/95 backdrop-blur-sm flex flex-col animate-in fade-in duration-200" onClick={onClose}>
                <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-50 bg-gradient-to-b from-black/50 to-transparent" onClick={e => e.stopPropagation()}>
                    <div className="text-white text-sm font-medium bg-black/30 px-3 py-1 rounded-full backdrop-blur-md">{currentIndex + 1} / {images.length}</div>
                    <div className="flex items-center gap-2">
                    <button onClick={() => setZoom(z => Math.max(0.5, z - 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors"><Minus size={20} /></button>
                    <button onClick={() => setZoom(z => Math.min(4, z + 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors"><Plus size={20} /></button>
                    <button onClick={() => { setZoom(1); setPosition({x:0, y:0}); }} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors text-xs font-bold">1x</button>
                    <div className="h-6 w-px bg-white/20 mx-1"></div>
                    <button onClick={onClose} className="p-2 text-white bg-red-600 hover:bg-red-700 rounded-full transition-colors shadow-lg"><X size={20} /></button>
                    </div>
                </div>
                <div className="flex-1 flex items-center justify-center overflow-hidden relative w-full h-full" onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    <button onClick={(e) => { e.stopPropagation(); onPrev(); }} disabled={images.length <= 1} className={`absolute left-4 z-40 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white backdrop-blur-md transition-all ${images.length <= 1 ? 'opacity-0 pointer-events-none' : ''}`}><ChevronLeft size={32} /></button>
                    <img src={currentImage} alt="Visualização" className={`max-w-full max-h-screen transition-transform duration-100 ease-out select-none ${zoom > 1 ? 'cursor-move' : ''}`} style={{ transform: `scale(${zoom}) translate(${position.x / zoom}px, ${position.y / zoom}px)` }} onClick={(e) => e.stopPropagation()} draggable={false} />
                    <button onClick={(e) => { e.stopPropagation(); onNext(); }} disabled={images.length <= 1} className={`absolute right-4 z-40 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white backdrop-blur-md transition-all ${images.length <= 1 ? 'opacity-0 pointer-events-none' : ''}`}><ChevronRight size={32} /></button>
                </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(() => { try { return localStorage.getItem('helpdesk_is_admin') === 'true'; } catch { return false; } });
            const [techName, setTechName] = useState(() => { try { return localStorage.getItem('helpdesk_tech_name') || ''; } catch { return ''; } });
            const [view, setView] = useState(() => { try { return localStorage.getItem('helpdesk_is_admin') === 'true' ? 'dashboard' : 'landing'; } catch { return 'landing'; } });
            const [tickets, setTickets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [userSector, setUserSector] = useState(() => { try { return localStorage.getItem('helpdesk_user_sector') || ''; } catch { return ''; } });
            const [userUnit, setUserUnit] = useState(() => { try { return localStorage.getItem('helpdesk_user_unit') || ''; } catch { return ''; } });
            const [unitFilter, setUnitFilter] = useState('Todas'); 
            const [priorityFilter, setPriorityFilter] = useState('Todas'); 
            const [typeFilter, setTypeFilter] = useState('Todos'); 
            const [techViewMode, setTechViewMode] = useState('active');
            const [expandedChatId, setExpandedChatId] = useState(null);
            const [activeChatTab, setActiveChatTab] = useState('public'); 
            const [showHistoryId, setShowHistoryId] = useState(null);
            const [loginForm, setLoginForm] = useState({ email: '', password: '' });
            const [loginError, setLoginError] = useState(false);
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [isAccessing, setIsAccessing] = useState(false);
            const [toast, setToast] = useState(null);
            const [sectorInput, setSectorInput] = useState('');
            const [unitInput, setUnitInput] = useState('');
            const [isTimeMenuOpen, setIsTimeMenuOpen] = useState(false);
            const [isUnitMenuOpen, setIsUnitMenuOpen] = useState(false);
            const [isPriorityMenuOpen, setIsPriorityMenuOpen] = useState(false);
            const [isTypeMenuOpen, setIsTypeMenuOpen] = useState(false);
            const [isMonthMenuOpen, setIsMonthMenuOpen] = useState(false);
            const [isYearMenuOpen, setIsYearMenuOpen] = useState(false);
            const [chatImagePreview, setChatImagePreview] = useState(null);
            const [chatImageFile, setChatImageFile] = useState(null);
            const [isCompressing, setIsCompressing] = useState(false);
            const fileInputRef = useRef(null);
            const [imageView, setImageView] = useState({ isOpen: false, images: [], currentIndex: 0 });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [lastReadTimes, setLastReadTimes] = useState(() => { try { const saved = localStorage.getItem('helpdesk_read_times'); return saved ? JSON.parse(saved) : {}; } catch { return {}; } });
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [confirmationModal, setConfirmationModal] = useState(null); 
            const [reportFilterMode, setReportFilterMode] = useState('today');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [dailyPhrase, setDailyPhrase] = useState('');
            const [ticketType, setTicketType] = useState('problem'); 
            const [firebaseError, setFirebaseError] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(() => { try { return localStorage.getItem('helpdesk_dark_mode') === 'true'; } catch { return false; } });
            const [isAudioEnabled, setIsAudioEnabled] = useState(true);

            // Inventário
            const [inventoryTab, setInventoryTab] = useState('equipments');
            const [equipments, setEquipments] = useState([]);
            const [accessories, setAccessories] = useState([]);
            const [isEqModalOpen, setIsEqModalOpen] = useState(false);
            const [isEqTypeMenuOpen, setIsEqTypeMenuOpen] = useState(false);
            const [editingEqId, setEditingEqId] = useState(null);
            const [decommissionEqModal, setDecommissionEqModal] = useState(null);
            const [decommissionReason, setDecommissionReason] = useState('');
            const [isAccModalOpen, setIsAccModalOpen] = useState(false);
            const [isAccTypeMenuOpen, setIsAccTypeMenuOpen] = useState(false);
            const [accMoveModal, setAccMoveModal] = useState(null);
            const [expandedLogId, setExpandedLogId] = useState(null);

            const [eqForm, setEqForm] = useState({ type: 'Notebook', model: '', specs: '', acquisitionDate: '', price: '', deviceId: '', status: 'guardado', unit: '', department: '', operator: '', anydeskId: '' });
            const [accForm, setAccForm] = useState({ type: 'Mouse', name: '', initialQuantity: 1 });
            const [accMoveForm, setAccMoveForm] = useState({ action: 'out', quantity: 1, unit: '', department: '', notes: '' });

            const [eqTypeFilter, setEqTypeFilter] = useState('Todos');
            const [eqUnitFilter, setEqUnitFilter] = useState('Todas');
            const [eqStatusFilter, setEqStatusFilter] = useState('Todos');
            const [eqSearchTerm, setEqSearchTerm] = useState('');
            const [accTypeFilter, setAccTypeFilter] = useState('Todos');
            const [isEqFilterMenuOpen, setIsEqFilterMenuOpen] = useState(false);
            const [isEqUnitMenuOpen, setIsEqUnitMenuOpen] = useState(false);
            const [isEqStatusMenuOpen, setIsEqStatusMenuOpen] = useState(false);
            const [isAccFilterMenuOpen, setIsAccFilterMenuOpen] = useState(false);

            const [kanbanTab, setKanbanTab] = useState('board');
            const [kanbanCards, setKanbanCards] = useState([]);
            const [isKanbanCardModalOpen, setIsKanbanCardModalOpen] = useState(false);
            const [selectedKanbanCard, setSelectedKanbanCard] = useState(null);
            const [draggedCardId, setDraggedCardId] = useState(null);
            const [isKanbanStatusMenuOpen, setIsKanbanStatusMenuOpen] = useState(false);

            const [kbCards, setKbCards] = useState([]);
            const [isKbCardModalOpen, setIsKbCardModalOpen] = useState(false);
            const [selectedKbCard, setSelectedKbCard] = useState(null);

            // Checklists
            const [checklists, setChecklists] = useState([]);
            const [isChecklistModalOpen, setIsChecklistModalOpen] = useState(false);
            const [selectedChecklist, setSelectedChecklist] = useState(null);
            const [checklistTab, setChecklistTab] = useState('pending');
            const [isRecurrenceMenuOpen, setIsRecurrenceMenuOpen] = useState(false);
            const recurrenceMenuRef = useRef(null);

            const availableYears = useMemo(() => {
                const baseYear = 2026;
                const currentYear = new Date().getFullYear();
                const yearsSet = new Set([baseYear, currentYear]);
                tickets.forEach(t => { if (t.createdAt?.toDate) { yearsSet.add(t.createdAt.toDate().getFullYear()); } });
                return Array.from(yearsSet).filter(y => y >= baseYear).sort((a, b) => b - a); 
            }, [tickets]);

            const [formData, setFormData] = useState({ requester: '', department: '', description: '', machineName: '', anydeskId: '', unit: '', accessTime: 'A Qualquer Momento' });

            const chatEndRef = useRef(null);
            const audioNewRef = useRef(typeof Audio !== "undefined" ? new Audio(SOUND_NEW_TICKET) : null);
            const audioUpdateRef = useRef(typeof Audio !== "undefined" ? new Audio(SOUND_UPDATE) : null);
            const prevTicketsRef = useRef({});
            const timeMenuRef = useRef(null);
            const unitMenuRef = useRef(null);
            const priorityMenuRef = useRef(null);
            const typeMenuRef = useRef(null);
            const monthMenuRef = useRef(null);
            const yearMenuRef = useRef(null);
            const eqTypeMenuRef = useRef(null);
            const accTypeMenuRef = useRef(null);
            const eqFilterMenuRef = useRef(null);
            const eqUnitMenuRef = useRef(null);
            const eqStatusMenuRef = useRef(null);
            const accFilterMenuRef = useRef(null);
            const kanbanStatusMenuRef = useRef(null);

            useEffect(() => {
                setPersistence(auth, browserLocalPersistence).catch(() => {});
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        const isTech = !currentUser.isAnonymous;
                        if (isTech) {
                            setIsAdmin(true);
                            localStorage.setItem('helpdesk_is_admin', 'true');
                            if (currentUser.email) {
                                const name = formatName(currentUser.email.split('@')[0]);
                                setTechName(name);
                                localStorage.setItem('helpdesk_tech_name', name);
                            }
                        } else {
                            setIsAdmin(false);
                            localStorage.removeItem('helpdesk_is_admin');
                            localStorage.removeItem('helpdesk_tech_name');
                            setView(v => (v === 'dashboard' || v === 'inventory' || v === 'reports' || v === 'archive' || v === 'kanban') ? 'landing' : v);
                        }
                    } else {
                        setIsAdmin(false);
                        localStorage.removeItem('helpdesk_is_admin');
                        localStorage.removeItem('helpdesk_tech_name');
                        signInAnonymously(auth).catch(e => {
                            if (e.code === 'auth/operation-not-allowed') {
                                setFirebaseError({title: "Auth Anônima", message: "Ative o login anônimo no Firebase Authentication."});
                            }
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => { localStorage.setItem('helpdesk_read_times', JSON.stringify(lastReadTimes)); }, [lastReadTimes]);
            useEffect(() => { localStorage.setItem('helpdesk_dark_mode', isDarkMode); }, [isDarkMode]);
            useEffect(() => { setDailyPhrase(MOTIVATIONAL_PHRASES[Math.floor(Math.random() * MOTIVATIONAL_PHRASES.length)]); }, []);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (timeMenuRef.current && !timeMenuRef.current.contains(event.target)) setIsTimeMenuOpen(false);
                    if (unitMenuRef.current && !unitMenuRef.current.contains(event.target)) setIsUnitMenuOpen(false);
                    if (priorityMenuRef.current && !priorityMenuRef.current.contains(event.target)) setIsPriorityMenuOpen(false);
                    if (typeMenuRef.current && !typeMenuRef.current.contains(event.target)) setIsTypeMenuOpen(false);
                    if (monthMenuRef.current && !monthMenuRef.current.contains(event.target)) setIsMonthMenuOpen(false);
                    if (yearMenuRef.current && !yearMenuRef.current.contains(event.target)) setIsYearMenuOpen(false);
                    if (eqTypeMenuRef.current && !eqTypeMenuRef.current.contains(event.target)) setIsEqTypeMenuOpen(false);
                    if (accTypeMenuRef.current && !accTypeMenuRef.current.contains(event.target)) setIsAccTypeMenuOpen(false);
                    if (eqFilterMenuRef.current && !eqFilterMenuRef.current.contains(event.target)) setIsEqFilterMenuOpen(false);
                    if (eqUnitMenuRef.current && !eqUnitMenuRef.current.contains(event.target)) setIsEqUnitMenuOpen(false);
                    if (eqStatusMenuRef.current && !eqStatusMenuRef.current.contains(event.target)) setIsEqStatusMenuOpen(false);
                    if (accFilterMenuRef.current && !accFilterMenuRef.current.contains(event.target)) setIsAccFilterMenuOpen(false);
                    if (kanbanStatusMenuRef.current && !kanbanStatusMenuRef.current.contains(event.target)) setIsKanbanStatusMenuOpen(false);
                    if (recurrenceMenuRef.current && !recurrenceMenuRef.current.contains(event.target)) setIsRecurrenceMenuOpen(false);
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                const handleBeforeInstallPrompt = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }, []);

            const handleInstallClick = () => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { setDeferredPrompt(null); }); } };

            const handleOpenTicketChat = (ticketId, tabType = 'public') => {
                if (view === 'landing' || view === 'login') { setView('dashboard'); }
                setTimeout(() => {
                    setExpandedChatId(ticketId);
                    setActiveChatTab(tabType);
                    markAsRead(ticketId, tabType);
                    const element = document.getElementById(`ticket-${ticketId}`);
                    if (element) { element.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    setToast(null);
                }, 300);
            };

            const showToast = (message, type = 'info', action = null) => {
                setToast({ message: String(message), type, action });
                setTimeout(() => setToast(null), action ? 6000 : 4000);
            };

            useEffect(() => {
                if (!user) return;
                if (!isAdmin && (!userSector || !userUnit)) return;
                const ticketsRef = collection(db, 'chamados');
                let isSubscribedLoad = true;
                
                const unsubscribe = onSnapshot(ticketsRef, (snapshot) => {
                    const ticketsList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const sorted = ticketsList.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    if (!isSubscribedLoad) {
                        snapshot.docChanges().forEach((change) => {
                            const docId = change.doc.id;
                            const currentData = change.doc.data();
                            const prevData = prevTicketsRef.current[docId];

                            if (change.type === "added" && isAdmin) {
                                playSound('new');
                                showToast(`Nova ${currentData.type === 'request' ? 'Solicitação' : 'Problema'} de ${formatName(currentData.requester)}`, 'info', { label: 'Ver', onClick: () => handleOpenTicketChat(docId) });
                            }

                            if (change.type === "modified" && prevData) {
                                const oldMsgs = prevData.messages || [];
                                const newMsgs = currentData.messages || [];
                                const lastMsg = newMsgs.length > oldMsgs.length ? newMsgs[newMsgs.length - 1] : null;

                                const oldInternalMsgs = prevData.internalMessages || [];
                                const newInternalMsgs = currentData.internalMessages || [];
                                const lastInternalMsg = newInternalMsgs.length > oldInternalMsgs.length ? newInternalMsgs[newInternalMsgs.length - 1] : null;

                                if (isAdmin) {
                                    if (lastMsg && lastMsg.senderRole === 'user') {
                                        playSound('update');
                                        showToast(`Nova mensagem de ${formatName(lastMsg.sender)}`, 'info', { label: 'Responder', onClick: () => handleOpenTicketChat(docId, 'public') });
                                    }
                                    if (lastInternalMsg && lastInternalMsg.senderRole === 'tech' && lastInternalMsg.sender !== techName) {
                                        playSound('update');
                                        showToast(`Nova mensagem interna de ${formatName(lastInternalMsg.sender)}`, 'info', { label: 'Ver', onClick: () => handleOpenTicketChat(docId, 'internal') });
                                    }
                                    if (currentData.status === 'contestado' && prevData.status !== 'contestado') {
                                        playSound('update');
                                        showToast(`Chamado #${docId.substring(0,4)} contestado!`, 'warning', { label: 'Ver', onClick: () => handleOpenTicketChat(docId, 'public') });
                                    }
                                }

                                if (!isAdmin) {
                                    const matchesContext = normalizeSearch(currentData.department) === normalizeSearch(userSector) && normalizeSearch(currentData.unit) === normalizeSearch(userUnit);
                                    if (matchesContext) {
                                        if (currentData.status !== prevData.status) {
                                            playSound('update');
                                            showToast(`Chamado #${docId.substring(0,4)}: ${STATUS_OPTIONS.find(s => s.id === currentData.status)?.label || currentData.status}`, 'success', { label: 'Ver', onClick: () => handleOpenTicketChat(docId) });
                                        }
                                        if (lastMsg && lastMsg.senderRole === 'tech') {
                                            playSound('update');
                                            showToast(`Nova mensagem do suporte em #${docId.substring(0,4)}`, 'info', { label: 'Ver Mensagem', onClick: () => handleOpenTicketChat(docId) });
                                        }
                                    }
                                }
                            }
                            prevTicketsRef.current[docId] = currentData;
                        });
                    } else {
                        snapshot.docs.forEach(doc => { prevTicketsRef.current[doc.id] = doc.data(); });
                        isSubscribedLoad = false;
                    }
                    setTickets(sorted);
                    setLoading(false);
                }, (error) => {
                    setLoading(false);
                });
                return () => { isSubscribedLoad = false; unsubscribe(); };
            }, [user, isAdmin, techName, userSector, userUnit]);

            useEffect(() => {
                if (!isAdmin || !user) { setEquipments([]); setAccessories([]); setKanbanCards([]); setKbCards([]); return; }
                let isMounted = true;
                const safeSetState = (setter, value) => { if (isMounted) setter(value); };

                const unsubEq = onSnapshot(collection(db, 'equipamentos'), (snapshot) => {
                    safeSetState(setEquipments, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (error) => { if (error.code === 'permission-denied') safeSetState(setEquipments, []); });

                const unsubAcc = onSnapshot(collection(db, 'acessorios'), (snapshot) => {
                    safeSetState(setAccessories, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (error) => { if (error.code === 'permission-denied') safeSetState(setAccessories, []); });

                const unsubKanban = onSnapshot(collection(db, 'kanban_cards'), (snapshot) => {
                    safeSetState(setKanbanCards, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (error) => {
                    if (error.code === 'permission-denied') {
                        safeSetState(setKanbanCards, []);
                        setFirebaseError({ title: "Acesso ao Kanban/KB/Checklists Bloqueado", message: "Adicione as regras das novas coleções no seu Console Firebase (Firestore > Regras).", code: `match /kanban_cards/{doc=**} {\n  allow read, write: if request.auth != null;\n}\nmatch /kb_cards/{doc=**} {\n  allow read, write: if request.auth != null;\n}\nmatch /checklists/{doc=**} {\n  allow read, write: if request.auth != null;\n}` });
                    }
                });

                const unsubKb = onSnapshot(collection(db, 'kb_cards'), (snapshot) => {
                    safeSetState(setKbCards, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (error) => { if (error.code === 'permission-denied') safeSetState(setKbCards, []); });

                const unsubChecklists = onSnapshot(collection(db, 'checklists'), (snapshot) => {
                    safeSetState(setChecklists, snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                }, (error) => { if (error.code === 'permission-denied') safeSetState(setChecklists, []); });

                return () => { isMounted = false; unsubEq(); unsubAcc(); unsubKanban(); unsubKb(); unsubChecklists(); };
            }, [isAdmin, user]);

            const playSound = (type) => {
                if (!isAudioEnabled) return;
                try {
                    const audio = type === 'new' ? audioNewRef.current : audioUpdateRef.current;
                    if (audio) {
                        audio.currentTime = 0;
                        const playPromise = audio.play();
                        if (playPromise !== undefined) { playPromise.catch(e => console.warn("Áudio bloqueado", e)); }
                    }
                } catch (e) { console.error("Erro ao tocar áudio", e); }
            }; 

            const markAsRead = (ticketId, type) => { setLastReadTimes(prev => ({ ...prev, [`${ticketId}_${type}`]: new Date().toISOString() })); };

            const hasUnreadMessages = (ticket) => {
                if (expandedChatId === ticket.id && activeChatTab === 'public') return false;
                const lastRead = lastReadTimes[`${ticket.id}_public`] || "0";
                const targetRole = isAdmin ? 'user' : 'tech';
                return (ticket.messages || []).some(m => m.senderRole === targetRole && m.timestamp > lastRead);
            };

            const hasUnreadInternal = (ticket) => {
                if (!isAdmin) return false;
                if (expandedChatId === ticket.id && activeChatTab === 'internal') return false;
                const lastRead = lastReadTimes[`${ticket.id}_internal`] || "0";
                return (ticket.internalMessages || []).some(m => m.senderRole === 'tech' && m.sender !== techName && m.timestamp > lastRead);
            };

            useEffect(() => {
                if (expandedChatId && activeChatTab) {
                    const ticket = tickets.find(t => t.id === expandedChatId);
                    if (ticket) {
                        const messages = activeChatTab === 'internal' ? ticket.internalMessages : ticket.messages;
                        if (messages && messages.length > 0) {
                            const lastMsgTimestamp = messages[messages.length - 1].timestamp;
                            setLastReadTimes(prev => {
                                const currentLastRead = prev[`${expandedChatId}_${activeChatTab}`] || "0";
                                if (lastMsgTimestamp > currentLastRead) { return { ...prev, [`${expandedChatId}_${activeChatTab}`]: new Date().toISOString() }; }
                                return prev;
                            });
                        }
                    }
                }
            }, [tickets, expandedChatId, activeChatTab]);

            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => setChatImagePreview(e.target.result);
                reader.readAsDataURL(file);
                setChatImageFile(file);
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = (e) => setChatImagePreview(e.target.result);
                        reader.readAsDataURL(file);
                        setChatImageFile(file);
                        return;
                    }
                }
            };

            const openImageViewer = (imgSrc, ticket) => {
                const msgs = activeChatTab === 'internal' ? ticket.internalMessages : ticket.messages;
                const images = (msgs || []).filter(m => m.image).map(m => m.image);
                const index = images.indexOf(imgSrc);
                if (index !== -1) setImageView({ isOpen: true, images: images, currentIndex: index });
            };

            const closeImageViewer = () => setImageView({ ...imageView, isOpen: false });
            const handleNextImage = () => setImageView(prev => ({ ...prev, currentIndex: (prev.currentIndex + 1) % prev.images.length }));
            const handlePrevImage = () => setImageView(prev => ({ ...prev, currentIndex: (prev.currentIndex - 1 + prev.images.length) % prev.images.length }));

            const handleAttachFile = async (e, collectionName, currentData, setCurrentData) => {
                const file = e.target.files[0];
                if (!file || !currentData.id) return;
                setIsSubmitting(true);
                try {
                    const storageRef = ref(storage, `${collectionName}_attachments/${currentData.id}/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snapshot.ref);
                    const newAttachment = { name: file.name, url, type: file.type };
                    await updateDoc(doc(db, collectionName, currentData.id), { attachments: arrayUnion(newAttachment), updatedAt: serverTimestamp() });
                    setCurrentData(prev => ({...prev, attachments: [...(prev.attachments || []), newAttachment]}));
                    showToast("Arquivo anexado com sucesso!", "success");
                } catch (err) { showToast("Erro ao anexar arquivo.", "error"); } finally { setIsSubmitting(false); e.target.value = ''; }
            };

            const handleRemoveAttachment = async (collectionName, currentData, setCurrentData, attachmentToRemove) => {
                if(!window.confirm("Deseja remover este anexo?")) return;
                setIsSubmitting(true);
                try {
                    const newAttachments = currentData.attachments.filter(a => a.url !== attachmentToRemove.url);
                    await updateDoc(doc(db, collectionName, currentData.id), { attachments: newAttachments, updatedAt: serverTimestamp() });
                    setCurrentData(prev => ({...prev, attachments: newAttachments}));
                    showToast("Anexo removido.", "success");
                } catch(e) { showToast("Erro ao remover anexo.", "error"); } finally { setIsSubmitting(false); }
            };

            useEffect(() => {
                let start = new Date(), end = new Date();
                if (reportFilterMode === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); } 
                else if (selectedMonth === 'all') { start = new Date(selectedYear, 0, 1); end = new Date(selectedYear, 11, 31, 23, 59, 59); } 
                else { start = new Date(selectedYear, selectedMonth, 1); end = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59); }
                const toLocalISO = (d) => { const offset = d.getTimezoneOffset() * 60000; return new Date(d.getTime() - offset).toISOString().split('T')[0]; };
                setDateFilter({ start: toLocalISO(start), end: toLocalISO(end) });
            }, [reportFilterMode, selectedMonth, selectedYear]);

            const setPresetDate = (mode) => {
                const today = new Date();
                if (mode === 'today') { setReportFilterMode('today'); } 
                else if (mode === 'month') { setReportFilterMode('custom'); setSelectedMonth(today.getMonth()); setSelectedYear(today.getFullYear()); } 
                else if (mode === 'year') { setReportFilterMode('custom'); setSelectedMonth('all'); setSelectedYear(today.getFullYear()); }
            };

            const filteredTickets = useMemo(() => {
                return tickets.filter(t => {
                    const matchesAccess = isAdmin || (userSector && userUnit && normalizeSearch(t.department) === normalizeSearch(userSector) && normalizeSearch(t.unit) === normalizeSearch(userUnit));
                    if (!matchesAccess) return false;
                    const matchesSearch = (t.requester || '').toLowerCase().includes(searchTerm.toLowerCase()) || (t.description || '').toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesUnit = !isAdmin || unitFilter === 'Todas' || t.unit === unitFilter;
                    const matchesPriority = !isAdmin || priorityFilter === 'Todas' || t.priority === priorityFilter;
                    const matchesType = !isAdmin || typeFilter === 'Todos' || (typeFilter === 'problem' ? (t.type === 'problem' || !t.type) : t.type === typeFilter);
                    const isFinalized = t.status === 'finalizado';
                    const isContested = t.status === 'contestado';

                    if (isAdmin) {
                        if (view === 'reports') {
                            if (!t.createdAt || !dateFilter.start || !dateFilter.end) return true;
                            try {
                                let ticketDate = t.createdAt?.toDate ? t.createdAt.toDate() : (t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : new Date(t.createdAt));
                                if (isNaN(ticketDate.getTime())) return true;
                                const offset = ticketDate.getTimezoneOffset() * 60000;
                                const ticketDateStr = new Date(ticketDate.getTime() - offset).toISOString().split('T')[0];
                                return ticketDateStr >= dateFilter.start && ticketDateStr <= dateFilter.end;
                            } catch (e) { return true; }
                        } 
                        if (view === 'archive') return isFinalized && matchesSearch && matchesUnit && matchesPriority && matchesType;
                        if (techViewMode === 'contested') return isContested && matchesSearch && matchesUnit && matchesPriority && matchesType;
                        if (techViewMode === 'others') return !isFinalized && !isContested && matchesSearch && matchesUnit && matchesPriority && matchesType && (t.technician !== 'Pendente' && t.technician !== techName);
                        return !isFinalized && !isContested && matchesSearch && matchesUnit && matchesPriority && matchesType && (t.technician === 'Pendente' || t.technician === techName);
                    }
                    return view === 'archive' ? isFinalized && matchesSearch : !isFinalized && matchesSearch;
                });
            }, [tickets, searchTerm, unitFilter, priorityFilter, typeFilter, isAdmin, userSector, userUnit, view, techViewMode, techName, dateFilter]);

            const activeCount = useMemo(() => tickets.filter(t => t.status !== 'finalizado' && t.status !== 'contestado' && (t.technician === 'Pendente' || t.technician === techName)).length, [tickets, techName]);
            const contestedCount = useMemo(() => tickets.filter(t => t.status === 'contestado').length, [tickets]);
            const othersCount = useMemo(() => tickets.filter(t => t.status !== 'finalizado' && t.status !== 'contestado' && t.technician !== 'Pendente' && t.technician !== techName).length, [tickets, techName]);

            const calculateStats = (data) => {
                const total = data.length;
                const finalized = data.filter(t => t.status === 'finalizado').length;
                const contested = data.filter(t => t.status === 'contestado' || (t.history && t.history.some(h => h.label === 'Chamado contestado pelo colaborador'))).length;
                const requests = data.filter(t => t.type === 'request').length;
                const countOccurrences = (arr, key) => arr.reduce((acc, curr) => { const val = formatDisplay(curr[key]); acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                const units = countOccurrences(data, 'unit');
                const sectors = countOccurrences(data, 'department');
                const getTop = (obj) => { const entries = Object.entries(obj).sort((a, b) => b[1] - a[1]); return entries.length > 0 ? entries[0] : null; }
                const techs = {};
                data.forEach(t => {
                    const tech = t.technician === 'Pendente' ? 'Sem Técnico' : t.technician;
                    if (!techs[tech]) techs[tech] = { active: 0, finalized: 0, total: 0 };
                    techs[tech].total += 1;
                    if (t.status === 'finalizado') techs[tech].finalized += 1; else techs[tech].active += 1;
                });
                return { total, finalized, contested, requests, topUnit: getTop(units), topSector: getTop(sectors), techs };
            };

            const reportData = useMemo(() => view === 'reports' ? calculateStats(filteredTickets) : null, [filteredTickets, view]);

            const filteredEquipments = useMemo(() => equipments.filter(eq => {
                if (eq.status === 'baixado') return false; 
                return (eqTypeFilter === 'Todos' || eq.type === eqTypeFilter) && 
                       (eqUnitFilter === 'Todas' || eq.unit === eqUnitFilter) && 
                       (eqStatusFilter === 'Todos' ? true : eq.status === eqStatusFilter) && 
                       (!eqSearchTerm || (eq.model && eq.model.toLowerCase().includes(eqSearchTerm.toLowerCase())) || (eq.deviceId && eq.deviceId.toLowerCase().includes(eqSearchTerm.toLowerCase())));
            }), [equipments, eqTypeFilter, eqUnitFilter, eqStatusFilter, eqSearchTerm]);

            const decommissionedEquipments = useMemo(() => equipments.filter(eq => eq.status === 'baixado' && (!eqSearchTerm || (eq.model && eq.model.toLowerCase().includes(eqSearchTerm.toLowerCase())) || (eq.deviceId && eq.deviceId.toLowerCase().includes(eqSearchTerm.toLowerCase())))), [equipments, eqSearchTerm]);
            const filteredAccessories = useMemo(() => accessories.filter(acc => accTypeFilter === 'Todos' || acc.type === accTypeFilter), [accessories, accTypeFilter]);

            const handleDragStart = (e, cardId) => { setDraggedCardId(cardId); e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData('text/plain', cardId); };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; };
            const handleDrop = async (e, columnId) => { e.preventDefault(); if (draggedCardId) { try { await updateDoc(doc(db, 'kanban_cards', draggedCardId), { status: columnId, updatedAt: serverTimestamp() }); } catch(err) { showToast("Erro ao mover cartão.", "error"); } setDraggedCardId(null); } };
            
            const handleSaveKanbanCard = async (e) => {
                e.preventDefault(); if (!selectedKanbanCard.title.trim()) return; setIsSubmitting(true);
                try {
                    if (selectedKanbanCard.id) {
                        await updateDoc(doc(db, 'kanban_cards', selectedKanbanCard.id), { title: selectedKanbanCard.title, description: selectedKanbanCard.description, assignee: selectedKanbanCard.assignee, status: selectedKanbanCard.status, updatedAt: serverTimestamp() });
                        showToast("Tarefa atualizada.", "success");
                    } else {
                        await addDoc(collection(db, 'kanban_cards'), { title: selectedKanbanCard.title, description: selectedKanbanCard.description || '', status: selectedKanbanCard.status || 'todo', assignee: selectedKanbanCard.assignee || '', comments: [], attachments: [], createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                        showToast("Tarefa criada.", "success");
                    }
                    setIsKanbanCardModalOpen(false); setSelectedKanbanCard(null);
                } catch(err) { showToast("Erro ao salvar tarefa.", "error"); } setIsSubmitting(false);
            };
            
            const handleDeleteKanbanCard = async () => { if (window.confirm("Deseja mesmo excluir esta tarefa permanentemente?")) { try { await deleteDoc(doc(db, 'kanban_cards', selectedKanbanCard.id)); showToast("Tarefa excluída.", "success"); setIsKanbanCardModalOpen(false); setSelectedKanbanCard(null); } catch(e) { showToast("Erro ao excluir", "error"); } } };
            
            const handleAddKanbanComment = async (e) => {
                e.preventDefault(); const input = e.target.comment; const text = input.value;
                if (!text.trim() || !selectedKanbanCard.id) return;
                try { await updateDoc(doc(db, 'kanban_cards', selectedKanbanCard.id), { comments: arrayUnion({ text, user: techName, timestamp: new Date().toISOString() }), updatedAt: serverTimestamp() }); input.value = ''; setSelectedKanbanCard(prev => ({...prev, comments: [...(prev.comments || []), { text, user: techName, timestamp: new Date().toISOString() }]})); } catch(err) { showToast("Erro ao comentar", "error"); }
            };

            const handleSaveKbCard = async (e) => {
                e.preventDefault(); if (!selectedKbCard.title.trim()) return; setIsSubmitting(true);
                try {
                    if (selectedKbCard.id) { await updateDoc(doc(db, 'kb_cards', selectedKbCard.id), { title: selectedKbCard.title, description: selectedKbCard.description, updatedAt: serverTimestamp() }); showToast("Informação atualizada.", "success"); } 
                    else { await addDoc(collection(db, 'kb_cards'), { title: selectedKbCard.title, description: selectedKbCard.description || '', attachments: [], createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); showToast("Informação registrada.", "success"); }
                    setIsKbCardModalOpen(false); setSelectedKbCard(null);
                } catch(err) { showToast("Erro ao salvar informação.", "error"); } setIsSubmitting(false);
            };
            
            const handleDeleteKbCard = async () => { if (window.confirm("Deseja excluir esta informação de forma permanente?")) { try { await deleteDoc(doc(db, 'kb_cards', selectedKbCard.id)); showToast("Informação excluída.", "success"); setIsKbCardModalOpen(false); setSelectedKbCard(null); } catch(e) { showToast("Erro ao excluir", "error"); } } };

            const handleEditEquipment = (eq) => { setEqForm({ type: eq.type || 'Notebook', model: eq.model || '', specs: eq.specs || '', acquisitionDate: eq.acquisitionDate || '', price: eq.price || '', deviceId: eq.deviceId || '', status: eq.status || 'guardado', unit: eq.unit || '', department: eq.department || '', operator: eq.operator || '', anydeskId: eq.anydeskId || '' }); setEditingEqId(eq.id); setIsEqModalOpen(true); };
            
            const handleSaveEquipment = async (e) => {
                e.preventDefault(); setIsSubmitting(true);
                try {
                    if (editingEqId) { await updateDoc(doc(db, 'equipamentos', editingEqId), { ...eqForm, updatedAt: serverTimestamp(), history: arrayUnion({ date: new Date().toISOString(), user: techName, action: `Equipamento atualizado/editado.` }) }); showToast("Equipamento atualizado com sucesso!", "success"); } 
                    else { await addDoc(collection(db, 'equipamentos'), { ...eqForm, history: [{ date: new Date().toISOString(), user: techName, action: `Equipamento cadastrado com status: ${eqForm.status === 'em_uso' ? 'Em uso' : 'Guardado'} (${eqForm.unit || 'Sem unidade'} - ${eqForm.department || 'Sem setor'})` }], createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); showToast("Equipamento cadastrado com sucesso!", "success"); }
                    setIsEqModalOpen(false); setEditingEqId(null); setEqForm({ type: 'Notebook', model: '', specs: '', acquisitionDate: '', price: '', deviceId: '', status: 'guardado', unit: '', department: '', operator: '', anydeskId: '' });
                } catch (err) { showToast("Erro ao salvar equipamento", "error"); } finally { setIsSubmitting(false); }
            };

            const handleUpdateEqStatus = async (eq, newStatus) => { try { await updateDoc(doc(db, 'equipamentos', eq.id), { status: newStatus, updatedAt: serverTimestamp(), history: arrayUnion({ date: new Date().toISOString(), user: techName, action: `Status alterado para: ${newStatus === 'em_uso' ? 'Em uso' : 'Guardado'}` }) }); showToast("Status atualizado", "success"); } catch (err) { showToast("Erro ao atualizar status", "error"); } };
            
            const handleDecommissionEquipment = async (e) => {
                e.preventDefault(); if (!decommissionEqModal || !decommissionReason.trim()) return; setIsSubmitting(true);
                try { await updateDoc(doc(db, 'equipamentos', decommissionEqModal.id), { status: 'baixado', decommissionReason: decommissionReason, decommissionDate: new Date().toISOString(), decommissionUser: techName, updatedAt: serverTimestamp(), history: arrayUnion({ date: new Date().toISOString(), user: techName, action: `Equipamento baixado. Motivo: ${decommissionReason}` }) }); showToast("Equipamento baixado com sucesso!", "success"); setDecommissionEqModal(null); setDecommissionReason(''); } catch(err) { showToast("Erro ao baixar equipamento", "error"); } finally { setIsSubmitting(false); }
            };
            
            const handleRestoreEquipment = async (eq) => { try { await updateDoc(doc(db, 'equipamentos', eq.id), { status: 'guardado', updatedAt: serverTimestamp(), history: arrayUnion({ date: new Date().toISOString(), user: techName, action: `Equipamento restaurado para o estoque (Guardado).` }) }); showToast("Equipamento restaurado!", "success"); } catch (err) { showToast("Erro ao restaurar equipamento", "error"); } };
            
            const handleSaveAccessory = async (e) => { e.preventDefault(); setIsSubmitting(true); try { await addDoc(collection(db, 'acessorios'), { type: accForm.type, name: accForm.name, quantity: parseInt(accForm.initialQuantity, 10), history: [{ date: new Date().toISOString(), user: techName, action: `Acessório cadastrado. Estoque inicial: ${accForm.initialQuantity}` }], createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); showToast("Acessório cadastrado com sucesso!", "success"); setIsAccModalOpen(false); setAccForm({ type: 'Mouse', name: '', initialQuantity: 1 }); } catch (err) { showToast("Erro ao cadastrar acessório", "error"); } finally { setIsSubmitting(false); } };
            
            const handleMoveAccessory = async (e) => {
                e.preventDefault(); if (!accMoveModal) return; setIsSubmitting(true);
                try {
                    const accessory = accessories.find(a => a.id === accMoveModal); const qtyToMove = parseInt(accMoveForm.quantity, 10);
                    if (accMoveForm.action === 'out' && qtyToMove > accessory.quantity) { showToast("Quantidade indisponível em estoque", "error"); setIsSubmitting(false); return; }
                    const newQty = accMoveForm.action === 'in' ? accessory.quantity + qtyToMove : accessory.quantity - qtyToMove;
                    let logAction = accMoveForm.action === 'in' ? `Entrada de +${qtyToMove} item(s). Novo saldo: ${newQty}` : `Saída de -${qtyToMove} item(s) para ${accMoveForm.unit} - ${accMoveForm.department}. Novo saldo: ${newQty}`;
                    if (accMoveForm.notes) logAction += ` | Obs: ${accMoveForm.notes}`;
                    await updateDoc(doc(db, 'acessorios', accessory.id), { quantity: newQty, updatedAt: serverTimestamp(), history: arrayUnion({ date: new Date().toISOString(), user: techName, action: logAction }) });
                    showToast("Movimentação registrada!", "success"); setAccMoveModal(null); setAccMoveForm({ action: 'out', quantity: 1, unit: '', department: '', notes: '' });
                } catch (err) { showToast("Erro ao movimentar acessório", "error"); } finally { setIsSubmitting(false); }
            };

            const isTaskDue = (task) => {
                if (!task.lastCompleted) return true;
                const last = new Date(task.lastCompleted);
                const now = new Date();
                if (task.recurrence === 'daily') {
                    return last.getDate() !== now.getDate() || last.getMonth() !== now.getMonth() || last.getFullYear() !== now.getFullYear();
                } else if (task.recurrence === 'weekly') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0,0,0,0);
                    return last < startOfWeek;
                } else if (task.recurrence === 'monthly') {
                    return last.getMonth() !== now.getMonth() || last.getFullYear() !== now.getFullYear();
                }
                return true;
            };

            const handleSaveChecklist = async (e) => {
                e.preventDefault(); if (!selectedChecklist.title.trim()) return; setIsSubmitting(true);
                try {
                    if (selectedChecklist.id) {
                        await updateDoc(doc(db, 'checklists', selectedChecklist.id), { title: selectedChecklist.title, description: selectedChecklist.description, assignee: selectedChecklist.assignee, recurrence: selectedChecklist.recurrence, updatedAt: serverTimestamp() });
                        showToast("Tarefa atualizada.", "success");
                    } else {
                        await addDoc(collection(db, 'checklists'), { title: selectedChecklist.title, description: selectedChecklist.description || '', assignee: selectedChecklist.assignee || '', recurrence: selectedChecklist.recurrence || 'daily', history: [], lastCompleted: null, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                        showToast("Tarefa criada.", "success");
                    }
                    setIsChecklistModalOpen(false); setSelectedChecklist(null);
                } catch(err) { showToast("Erro ao salvar tarefa.", "error"); } setIsSubmitting(false);
            };

            const handleDeleteChecklist = async () => {
                if (window.confirm("Deseja mesmo excluir esta tarefa permanentemente?")) {
                    try { await deleteDoc(doc(db, 'checklists', selectedChecklist.id)); showToast("Tarefa excluída.", "success"); setIsChecklistModalOpen(false); setSelectedChecklist(null); } catch(e) { showToast("Erro ao excluir", "error"); }
                }
            };

            const handleCompleteTask = async (task) => {
                try {
                    const nowIso = new Date().toISOString();
                    await updateDoc(doc(db, 'checklists', task.id), { lastCompleted: nowIso, history: arrayUnion({ completedAt: nowIso, user: techName }), updatedAt: serverTimestamp() });
                    playSound('update');
                    showToast("Tarefa concluída com sucesso!", "success");
                } catch (err) { showToast("Erro ao concluir tarefa.", "error"); }
            };

            const handleLogin = async (e) => {
                e.preventDefault(); setLoginError(false); setIsLoggingIn(true);
                if (!loginForm.email || !loginForm.password) { setLoginError(true); setIsLoggingIn(false); return; }
                try {
                    const emailToUse = loginForm.email.trim().includes('@') ? loginForm.email.trim() : `${loginForm.email.trim()}${EMAIL_DOMAIN}`;
                    const userCredential = await signInWithEmailAndPassword(auth, emailToUse, loginForm.password);
                    const name = userCredential.user.email.split('@')[0]; 
                    setIsAdmin(true); setTechName(formatName(name)); setView('dashboard');
                    localStorage.setItem('helpdesk_is_admin', 'true'); localStorage.setItem('helpdesk_tech_name', name);
                    setLoginForm({ email: '', password: '' }); showToast(`Bem-vindo, ${formatName(name)}!`, 'success');
                } catch (error) { setLoginError(true); showToast("Falha no login. Verifique as credenciais.", "error"); } finally { setIsLoggingIn(false); }
            };

            const handleLogout = () => { signOut(auth).then(() => { setIsAdmin(false); setTechName(''); localStorage.removeItem('helpdesk_is_admin'); localStorage.removeItem('helpdesk_tech_name'); showToast("Sessão encerrada"); setView('landing'); }); };

            const handleAccessConfirm = async () => {
                setIsAccessing(true); await new Promise(r => setTimeout(r, 600));
                if (unitInput.trim() && sectorInput.trim()) {
                    let finalUnit = unitInput.trim(); const unitMap = { "bw": "Bonway", "evt": "Everest", "evs": "EverSky", "ht": "Barueri", "gd": "Good" };
                    if (unitMap[finalUnit.toLowerCase()]) finalUnit = unitMap[finalUnit.toLowerCase()];
                    setUserUnit(finalUnit); setUserSector(sectorInput.trim());
                    localStorage.setItem('helpdesk_user_unit', finalUnit); localStorage.setItem('helpdesk_user_sector', sectorInput.trim());
                    showToast("Acesso autorizado!");
                } else { showToast("Preencha os dados.", "error"); }
                setIsAccessing(false);
            };

            const handleCreateTicket = async (e) => {
                e.preventDefault(); if (!formData.requester || !formData.department || !formData.description || !formData.unit) { showToast("Preencha os campos obrigatórios.", "error"); return; }
                setIsSubmitting(true);
                try {
                    let normalizedUnit = formData.unit.trim(); const unitMap = { "bw": "Bonway", "evt": "Everest", "evs": "EverSky", "ht": "Barueri", "gd": "Good" };
                    if (unitMap[normalizedUnit.toLowerCase()]) normalizedUnit = unitMap[normalizedUnit.toLowerCase()];
                    const finalData = { ...formData, unit: normalizedUnit, type: ticketType, status: 'aguardando', priority: 'baixa', technician: 'Pendente', notes: '', messages: [], internalMessages: [], history: [{ type: 'creation', label: 'Chamado aberto', timestamp: new Date().toISOString(), user: formatName(formData.requester) }], createdAt: serverTimestamp(), updatedAt: serverTimestamp(), userId: user ? user.uid : 'anon' };
                    if (ticketType === 'request') { finalData.machineName = ''; finalData.anydeskId = ''; finalData.accessTime = ''; }
                    await addDoc(collection(db, 'chamados'), finalData);
                    if (!userSector || !userUnit) { setUserSector(formData.department); setUserUnit(normalizedUnit); localStorage.setItem('helpdesk_user_sector', formData.department); localStorage.setItem('helpdesk_user_unit', normalizedUnit); }
                    setFormData({ requester: '', department: '', description: '', machineName: '', anydeskId: '', unit: '', accessTime: 'A Qualquer Momento' }); setTicketType('problem'); setView('dashboard');
                    showToast("Chamado criado com sucesso!", "success");
                } catch (error) { showToast("Erro ao criar chamado.", "error"); } finally { setIsSubmitting(false); }
            };

            const updateTicketData = async (ticketId, updates, historyLabel) => { try { const dataToUpdate = { ...updates, updatedAt: serverTimestamp() }; if (historyLabel) dataToUpdate.history = arrayUnion({ type: 'update', label: historyLabel, timestamp: new Date().toISOString(), user: isAdmin ? techName : 'Colaborador' }); await updateDoc(doc(db, 'chamados', ticketId), dataToUpdate); } catch (error) { showToast("Erro ao atualizar chamado.", "error"); } };
            const executeContestTicket = async (ticketId) => { try { await updateTicketData(ticketId, { status: 'contestado' }, 'Chamado contestado pelo colaborador'); showToast("Chamado reaberto para análise!", "warning"); if (view === 'archive') setView('dashboard'); } catch (e) { showToast("Erro ao contestar.", "error"); } };
            const requestContestTicket = (ticketId) => { setConfirmationModal({ message: "Deseja contestar a finalização deste chamado? Ele será reaberto para atendimento.", onConfirm: () => executeContestTicket(ticketId) }); };

            const sendChatMessage = async (ticketId, text, isInternal = false) => {
                if (!text.trim() && !chatImageFile) return; if (!user) { showToast("Você precisa estar conectado para enviar mensagens.", "error"); return; }
                const ticket = tickets.find(t => t.id === ticketId); let imageUrl = null;
                try {
                    if (chatImageFile) { const snapshot = await uploadBytes(ref(storage, `attachments/${ticketId}/${Date.now()}_${chatImageFile.name}`), chatImageFile); imageUrl = await getDownloadURL(snapshot.ref); }
                    const newMessage = { text: text, sender: isAdmin ? techName : ticket?.requester || "Usuário", senderRole: isAdmin ? 'tech' : 'user', timestamp: new Date().toISOString() };
                    if (imageUrl) newMessage.image = imageUrl;
                    await updateDoc(doc(db, 'chamados', ticketId), { [isInternal ? 'internalMessages' : 'messages']: arrayUnion(newMessage), updatedAt: serverTimestamp() });
                    markAsRead(ticketId, isInternal ? 'internal' : 'public'); setChatImageFile(null); setChatImagePreview(null);
                } catch (error) { showToast("Erro ao enviar mensagem", "error"); }
            };

            return (
                <div className={`h-screen overflow-y-auto overflow-x-hidden flex flex-col font-sans transition-colors duration-300 ${isDarkMode ? 'dark bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`} style={{ colorScheme: isDarkMode ? 'dark' : 'light', '--scrollbar-track': isDarkMode ? '#020617' : '#f8fafc', '--scrollbar-thumb': isDarkMode ? '#334155' : '#cbd5e1', '--scrollbar-hover': isDarkMode ? '#475569' : '#94a3b8' }}>
                    <style>{customScrollStyles}</style>
                    {firebaseError && (<div className="fixed inset-0 z-[100] bg-slate-900/95 flex items-center justify-center p-4"><div className="bg-white dark:bg-slate-800 p-8 rounded-3xl max-w-lg w-full border border-red-500 shadow-2xl relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-red-500"></div><div className="flex items-center gap-3 mb-4 text-red-600 dark:text-red-400"><AlertOctagon size={48} /><h2 className="text-2xl font-black leading-tight">Configuração Necessária</h2></div><p className="text-slate-600 dark:text-slate-300 mb-6 font-medium text-lg">{firebaseError.title}</p><div className="bg-slate-100 dark:bg-slate-950 rounded-xl p-4 mb-6 border border-slate-200 dark:border-slate-800"><p className="text-sm text-slate-500 mb-2 font-bold uppercase tracking-widest flex items-center gap-2"><Terminal size={14}/> Console do Firebase</p><p className="text-sm font-mono text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{firebaseError.message}</p></div><button onClick={() => setFirebaseError(null)} className="w-full py-4 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white rounded-xl font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Entendi, vou configurar</button></div></div>)}
                    <ImageViewer isOpen={imageView.isOpen} onClose={closeImageViewer} images={imageView.images} currentIndex={imageView.currentIndex} onNext={handleNextImage} onPrev={handlePrevImage} />
                    {confirmationModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 max-w-sm w-full border dark:border-slate-700 animate-in zoom-in-95"><h3 className="text-lg font-bold mb-2 dark:text-white flex items-center gap-2"><AlertTriangle className="text-orange-500" /> Confirmar Ação</h3><p className="text-slate-600 dark:text-slate-300 mb-6 text-sm leading-relaxed">{confirmationModal.message}</p><div className="flex gap-3 justify-end"><button onClick={() => setConfirmationModal(null)} className="px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Cancelar</button><button onClick={() => { confirmationModal.onConfirm(); setConfirmationModal(null); }} className="px-4 py-2 rounded-xl text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/20">Confirmar</button></div></div></div>)}
                    {decommissionEqModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-md border dark:border-slate-800 overflow-hidden"><div className="p-6 border-b dark:border-slate-800 bg-red-50 dark:bg-red-900/20 flex justify-between items-center"><div><h3 className="text-lg font-bold text-red-600 dark:text-red-400 flex items-center gap-2"><Trash2 size={20}/> Dar Baixa em Equipamento</h3><p className="text-xs text-red-500/70 mt-1 font-medium">{decommissionEqModal.model} ({decommissionEqModal.deviceId || 'Sem ID'})</p></div><button onClick={() => {setDecommissionEqModal(null); setDecommissionReason('');}} className="text-red-400 hover:text-red-600 transition-colors"><X size={20}/></button></div><div className="p-6"><form onSubmit={handleDecommissionEquipment} className="space-y-4"><p className="text-sm text-slate-600 dark:text-slate-300 font-medium leading-relaxed">Tem certeza que deseja dar baixa neste equipamento? Esta ação o removerá do inventário ativo.</p><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Motivo da Baixa</label><textarea required className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-500 dark:text-white font-medium resize-none h-24" placeholder="Ex: Equipamento quebrado, doado, leiloado..." value={decommissionReason} onChange={(e) => setDecommissionReason(e.target.value)} /></div><div className="pt-4 flex gap-3"><button type="button" onClick={() => {setDecommissionEqModal(null); setDecommissionReason('');}} className="flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Cancelar</button><button type="submit" disabled={isSubmitting} className="flex-1 py-3.5 rounded-xl font-bold text-sm text-white shadow-lg transition-all disabled:opacity-50 bg-red-600 hover:bg-red-700 shadow-red-500/20">Confirmar Baixa</button></div></form></div></div></div>)}
                    {isKanbanCardModalOpen && selectedKanbanCard && (<div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-3xl border dark:border-slate-800 flex flex-col max-h-[90vh]"><div className="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-3xl"><h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><Kanban size={20} className="text-blue-600"/> {selectedKanbanCard.id ? 'Detalhes da Tarefa' : 'Nova Tarefa'}</h3><div className="flex items-center gap-2">{selectedKanbanCard.id && (<button onClick={handleDeleteKanbanCard} className="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20" title="Excluir Cartão"><Trash2 size={18}/></button>)}<button onClick={() => { setIsKanbanCardModalOpen(false); setSelectedKanbanCard(null); }} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-2"><X size={24}/></button></div></div><div className="flex-1 overflow-y-auto p-6 custom-scrollbar flex flex-col md:flex-row gap-8"><div className="flex-1 space-y-6"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Título</label><input type="text" autoFocus className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="O que precisa ser feito?" value={selectedKanbanCard.title} onChange={(e) => setSelectedKanbanCard({...selectedKanbanCard, title: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><AlignLeft size={12}/> Descrição</label><textarea className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white resize-none min-h-[120px] custom-scrollbar" placeholder="Adicione detalhes, passos..." value={selectedKanbanCard.description} onChange={(e) => setSelectedKanbanCard({...selectedKanbanCard, description: e.target.value})} /></div>{selectedKanbanCard.id ? (<><div className="pt-4 border-t dark:border-slate-800"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5 mb-3"><Paperclip size={12}/> Anexos</label><div className="space-y-3">{selectedKanbanCard.attachments?.length > 0 && (<div className="grid grid-cols-1 sm:grid-cols-2 gap-2">{selectedKanbanCard.attachments.map((att, i) => (<div key={i} className="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-800/80 rounded-xl border dark:border-slate-700/50"><a href={att.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs font-bold text-blue-600 hover:underline truncate">{att.type.includes('image') ? <ImageIcon size={14} className="flex-shrink-0"/> : <FileText size={14} className="flex-shrink-0"/>}<span className="truncate">{att.name}</span></a><button type="button" onClick={() => handleRemoveAttachment('kanban_cards', selectedKanbanCard, setSelectedKanbanCard, att)} className="text-slate-400 hover:text-red-500 p-1 flex-shrink-0"><X size={12}/></button></div>))}</div>)}<div className="relative"><input type="file" onChange={(e) => handleAttachFile(e, 'kanban_cards', selectedKanbanCard, setSelectedKanbanCard)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" disabled={isSubmitting} /><button type="button" className="w-full py-2.5 rounded-xl text-xs font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 dark:bg-slate-800/50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2 border border-dashed border-slate-300 dark:border-slate-600">{isSubmitting ? <div className="animate-spin w-3 h-3 border-2 border-slate-500 border-t-transparent rounded-full"></div> : <Plus size={14}/>}Adicionar Anexo</button></div></div></div><div className="pt-4 border-t dark:border-slate-800"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5 mb-4"><MessageSquare size={12}/> Atividades e Comentários</label><div className="space-y-4 mb-4 max-h-40 overflow-y-auto custom-scrollbar pr-2">{(selectedKanbanCard.comments || []).map((c, i) => (<div key={i} className="bg-slate-50 dark:bg-slate-800/80 p-3 rounded-2xl text-sm border dark:border-slate-700/50"><div className="flex justify-between items-center mb-1"><span className="font-bold text-slate-700 dark:text-slate-200 text-xs">{c.user}</span><span className="text-[9px] text-slate-400">{formatTimestamp(c.timestamp)}</span></div><p className="text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed">{c.text}</p></div>))}{(!selectedKanbanCard.comments || selectedKanbanCard.comments.length === 0) && <p className="text-xs text-slate-400 font-bold text-center py-4">Nenhum comentário adicionado.</p>}</div><form onSubmit={handleAddKanbanComment} className="flex gap-2 relative"><input type="text" name="comment" placeholder="Escreva um comentário..." autoComplete="off" className="flex-1 px-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition-all" /><button type="submit" className="p-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors shadow-md active:scale-95"><Send size={18}/></button></form></div></>) : (<div className="pt-4 border-t dark:border-slate-800 flex flex-col items-center justify-center text-center py-6 opacity-60"><Paperclip size={24} className="mb-2 text-slate-400"/><p className="text-xs font-bold text-slate-500 dark:text-slate-400">Salve a tarefa primeiro para liberar anexos e comentários.</p></div>)}</div><div className="w-full md:w-64 flex flex-col gap-6"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Coluna (Status)</label><div className="relative" ref={kanbanStatusMenuRef}><button type="button" onClick={() => setIsKanbanStatusMenuOpen(!isKanbanStatusMenuOpen)} className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-bold flex items-center justify-between outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><span className="truncate">{KANBAN_COLUMNS.find(c => c.id === selectedKanbanCard.status)?.title || 'Status'}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isKanbanStatusMenuOpen ? 'rotate-180' : ''}`} /></button>{isKanbanStatusMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200">{KANBAN_COLUMNS.map(c => (<button key={c.id} type="button" onClick={() => { setSelectedKanbanCard({...selectedKanbanCard, status: c.id}); setIsKanbanStatusMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{c.title} {selectedKanbanCard.status === c.id && <Check size={14} className="text-blue-600" />}</button>))}</div>)}</div></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><User size={12}/> Responsável</label><input type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="Nome do responsável..." value={selectedKanbanCard.assignee} onChange={(e) => setSelectedKanbanCard({...selectedKanbanCard, assignee: e.target.value})} /></div><div className="mt-auto pt-6 border-t dark:border-slate-800"><button onClick={handleSaveKanbanCard} disabled={isSubmitting} className="w-full py-3.5 rounded-xl font-black text-sm bg-blue-600 text-white shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all disabled:opacity-50 flex items-center justify-center gap-2 active:scale-95">{isSubmitting ? <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> : <Check size={18} />}{selectedKanbanCard.id ? 'Salvar Tarefa' : 'Criar Tarefa'}</button></div></div></div></div></div>)}
                        {isKbCardModalOpen && selectedKbCard && (<div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-2xl border dark:border-slate-800 flex flex-col max-h-[90vh]"><div className="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-3xl"><h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><BookOpen size={20} className="text-blue-600"/> {selectedKbCard.id ? 'Detalhes da Informação' : 'Nova Informação Padrão'}</h3><div className="flex items-center gap-2">{selectedKbCard.id && (<button onClick={handleDeleteKbCard} className="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20" title="Excluir"><Trash2 size={18}/></button>)}<button onClick={() => { setIsKbCardModalOpen(false); setSelectedKbCard(null); }} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-2"><X size={24}/></button></div></div><div className="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Título</label><input type="text" autoFocus className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="Ex: Senha Padrão do Wi-Fi Visitantes" value={selectedKbCard.title} onChange={(e) => setSelectedKbCard({...selectedKbCard, title: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><AlignLeft size={12}/> Conteúdo / Links</label><textarea className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white resize-none min-h-[160px] custom-scrollbar" placeholder="Digite os dados, procedimentos ou links importantes aqui..." value={selectedKbCard.description} onChange={(e) => setSelectedKbCard({...selectedKbCard, description: e.target.value})} /></div>{selectedKbCard.id ? (<div className="pt-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5 mb-3"><Paperclip size={12}/> Anexos Auxiliares</label><div className="space-y-3">{selectedKbCard.attachments?.length > 0 && (<div className="grid grid-cols-1 sm:grid-cols-2 gap-3">{selectedKbCard.attachments.map((att, i) => (<div key={i} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/80 rounded-2xl border dark:border-slate-700/50"><a href={att.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 text-xs font-bold text-blue-600 hover:underline truncate"><div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">{att.type.includes('image') ? <ImageIcon size={16}/> : <FileText size={16}/>}</div><span className="truncate">{att.name}</span></a><button type="button" onClick={() => handleRemoveAttachment('kb_cards', selectedKbCard, setSelectedKbCard, att)} className="text-slate-400 hover:text-red-500 p-1 flex-shrink-0"><X size={16}/></button></div>))}</div>)}<div className="relative"><input type="file" onChange={(e) => handleAttachFile(e, 'kb_cards', selectedKbCard, setSelectedKbCard)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" disabled={isSubmitting} /><button type="button" className="w-full py-3 rounded-2xl text-xs font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800/50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2 border border-dashed border-slate-300 dark:border-slate-600">{isSubmitting ? <div className="animate-spin w-4 h-4 border-2 border-slate-500 border-t-transparent rounded-full"></div> : <Plus size={16}/>}Adicionar Documento ou Imagem</button></div></div></div>) : (<div className="pt-4 border-t dark:border-slate-800 flex flex-col items-center justify-center text-center py-4 opacity-60"><p className="text-xs font-bold text-slate-500 dark:text-slate-400">Salve a informação primeiro para liberar a adição de anexos.</p></div>)}</div><div className="p-6 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 rounded-b-3xl flex justify-end gap-3"><button onClick={() => { setIsKbCardModalOpen(false); setSelectedKbCard(null); }} className="px-6 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancelar</button><button onClick={handleSaveKbCard} disabled={isSubmitting} className="px-6 py-3 rounded-xl font-black text-sm bg-blue-600 text-white shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all disabled:opacity-50 flex items-center justify-center gap-2 active:scale-95">{isSubmitting ? <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> : <Check size={18} />}{selectedKbCard.id ? 'Salvar Alterações' : 'Criar Informação'}</button></div></div></div>)}

                        {isChecklistModalOpen && selectedChecklist && (<div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-2xl border dark:border-slate-800 flex flex-col max-h-[90vh]"><div className="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-3xl"><h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><ListTodo size={20} className="text-blue-600"/> {selectedChecklist.id ? 'Detalhes da Tarefa' : 'Nova Tarefa Recorrente'}</h3><div className="flex items-center gap-2">{selectedChecklist.id && (<button onClick={handleDeleteChecklist} className="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20" title="Excluir"><Trash2 size={18}/></button>)}<button onClick={() => { setIsChecklistModalOpen(false); setSelectedChecklist(null); }} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-2"><X size={24}/></button></div></div><div className="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Tarefa</label><input type="text" autoFocus className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="Ex: Verificar backups dos servidores" value={selectedChecklist.title} onChange={(e) => setSelectedChecklist({...selectedChecklist, title: e.target.value})} /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Repeat size={12}/> Repetição</label><div className="relative" ref={recurrenceMenuRef}><button type="button" onClick={() => setIsRecurrenceMenuOpen(!isRecurrenceMenuOpen)} className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-bold flex items-center justify-between outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><span className="truncate">{selectedChecklist.recurrence === 'daily' ? 'Diariamente' : selectedChecklist.recurrence === 'weekly' ? 'Semanalmente' : 'Mensalmente'}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isRecurrenceMenuOpen ? 'rotate-180' : ''}`} /></button>{isRecurrenceMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200">{[{id:'daily', label:'Diariamente'}, {id:'weekly', label:'Semanalmente'}, {id:'monthly', label:'Mensalmente'}].map(r => (<button key={r.id} type="button" onClick={() => { setSelectedChecklist({...selectedChecklist, recurrence: r.id}); setIsRecurrenceMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{r.label} {selectedChecklist.recurrence === r.id && <Check size={14} className="text-blue-600" />}</button>))}</div>)}</div></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><User size={12}/> Responsável (Opcional)</label><input type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="Nome..." value={selectedChecklist.assignee} onChange={(e) => setSelectedChecklist({...selectedChecklist, assignee: e.target.value})} /></div></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><AlignLeft size={12}/> Detalhes / Observações</label><textarea className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white resize-none min-h-[100px] custom-scrollbar" placeholder="Instruções ou informações adicionais sobre a tarefa..." value={selectedChecklist.description} onChange={(e) => setSelectedChecklist({...selectedChecklist, description: e.target.value})} /></div>{selectedChecklist.id && (<div className="pt-4 border-t dark:border-slate-800"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5 mb-3"><History size={12}/> Histórico de Conclusão</label><div className="space-y-2 max-h-32 overflow-y-auto custom-scrollbar pr-2">{(selectedChecklist.history || []).length > 0 ? [...selectedChecklist.history].reverse().map((h, i) => (<div key={i} className="flex justify-between items-center text-xs p-2.5 bg-slate-50 dark:bg-slate-800/50 rounded-xl border dark:border-slate-700/50"><span className="font-bold dark:text-white">{h.user}</span><span className="text-slate-500">{formatTimestamp(h.completedAt)}</span></div>)) : <p className="text-xs text-slate-400 font-bold italic py-2">Nenhum registro de conclusão.</p>}</div></div>)}</div><div className="p-6 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 rounded-b-3xl flex justify-end gap-3"><button onClick={() => { setIsChecklistModalOpen(false); setSelectedChecklist(null); }} className="px-6 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancelar</button><button onClick={handleSaveChecklist} disabled={isSubmitting} className="px-6 py-3 rounded-xl font-black text-sm bg-blue-600 text-white shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all disabled:opacity-50 flex items-center justify-center gap-2 active:scale-95">{isSubmitting ? <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> : <Check size={18} />}{selectedChecklist.id ? 'Salvar Alterações' : 'Criar Tarefa'}</button></div></div></div>)}

                    {toast && (<div className={`fixed top-4 right-4 z-50 p-4 rounded-2xl shadow-2xl flex flex-col gap-2 animate-in fade-in slide-in-from-right-10 duration-300 max-w-sm w-full border ${ toast.type === 'error' ? 'bg-red-50 dark:bg-red-900/90 border-red-100 dark:border-red-800 text-red-800 dark:text-white' : toast.type === 'success' ? 'bg-green-50 dark:bg-green-900/90 border-green-100 dark:border-green-800 text-green-800 dark:text-white' : toast.type === 'warning' ? 'bg-orange-50 dark:bg-orange-900/90 border-orange-100 dark:border-orange-800 text-orange-800 dark:text-white' : 'bg-blue-50 dark:bg-blue-900/90 border-blue-100 dark:border-blue-800 text-blue-800 dark:text-white' }`}><div className="flex items-start justify-between gap-3"><div className="flex items-start gap-3"><div className="mt-0.5">{toast.type === 'error' ? <AlertCircle size={20} /> : toast.type === 'warning' ? <AlertTriangle size={20} /> : <CheckCircle size={20} />}</div><span className="font-bold text-sm leading-tight">{toast.message}</span></div><button onClick={() => setToast(null)} className="opacity-60 hover:opacity-100"><X size={16} /></button></div>{toast.action && (<button onClick={() => { toast.action.onClick(); setToast(null); }} className="mt-1 self-end text-xs font-black uppercase tracking-wider bg-white/50 hover:bg-white/80 dark:bg-black/20 dark:hover:bg-black/40 px-3 py-1.5 rounded-lg transition-colors">{toast.action.label} <ChevronRight size={12} className="inline ml-1"/></button>)}</div>)}
                    
                    {isEqModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200 overflow-y-auto"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-2xl border dark:border-slate-800 my-8"><div className="p-6 border-b dark:border-slate-800 flex justify-between items-center"><h3 className="text-xl font-bold dark:text-white flex items-center gap-2"><Monitor size={24} className="text-blue-600"/> {editingEqId ? 'Editar Equipamento' : 'Cadastro de Equipamento'}</h3><button onClick={() => setIsEqModalOpen(false)} className="text-slate-400 hover:text-red-500 transition-colors"><X size={24}/></button></div><div className="p-6"><form onSubmit={handleSaveEquipment} className="space-y-4"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Tipo de Equipamento</label><div className="relative" ref={eqTypeMenuRef}><button type="button" onClick={() => setIsEqTypeMenuOpen(!isEqTypeMenuOpen)} className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-medium flex items-center justify-between outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><span className="truncate">{eqForm.type}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isEqTypeMenuOpen ? 'rotate-180' : ''}`} /></button>{isEqTypeMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200 custom-scrollbar max-h-48 overflow-y-auto">{EQUIPMENT_TYPES.map(t => (<button key={t} type="button" onClick={() => { setEqForm({...eqForm, type: t}); setIsEqTypeMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{t} {eqForm.type === t && <Check size={14} className="text-blue-600" />}</button>))}</div>)}</div></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">ID do Dispositivo (IMEI/MAC)</label><input type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: 00:1A:2B:3C:4D / 1234567890" value={eqForm.deviceId} onChange={(e) => setEqForm({...eqForm, deviceId: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Modelo / Marca</label><input required type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: Dell Inspiron 15" value={eqForm.model} onChange={(e) => setEqForm({...eqForm, model: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Especificações Técnicas</label><input type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: i5, 16GB RAM, 512GB SSD" value={eqForm.specs} onChange={(e) => setEqForm({...eqForm, specs: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Data de Aquisição</label><input type="text" maxLength={10} placeholder="DD/MM/AAAA" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" value={eqForm.acquisitionDate} onChange={(e) => { let val = e.target.value.replace(/\D/g, ''); if (val.length > 8) val = val.substring(0, 8); if (val.length > 4) { val = val.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3'); } else if (val.length > 2) { val = val.replace(/(\d{2})(\d{1,2})/, '$1/$2'); } setEqForm({...eqForm, acquisitionDate: val}); }} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Preço (R$)</label><input type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="R$ 0,00" value={eqForm.price ? parseFloat(eqForm.price).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : ''} onChange={(e) => { let val = e.target.value.replace(/\D/g, ''); if (!val) { setEqForm({...eqForm, price: ''}); } else { setEqForm({...eqForm, price: (parseInt(val, 10) / 100).toString()}); } }} /></div></div><div className="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-2xl border border-blue-100 dark:border-blue-900/30 space-y-4 mt-4"><p className="text-[10px] font-black uppercase tracking-widest text-blue-600 dark:text-blue-400 mb-2">Atribuição e Localização (Opcional)</p><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Unidade</label><input type="text" className="w-full px-4 py-3 bg-white dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium shadow-sm" placeholder="Ex: Bonway" value={eqForm.unit} onChange={(e) => setEqForm({...eqForm, unit: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Setor</label><input type="text" className="w-full px-4 py-3 bg-white dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium shadow-sm" placeholder="Ex: Comercial" value={eqForm.department} onChange={(e) => setEqForm({...eqForm, department: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Operador</label><input type="text" className="w-full px-4 py-3 bg-white dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium shadow-sm" placeholder="Ex: João Silva" value={eqForm.operator} onChange={(e) => setEqForm({...eqForm, operator: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">AnyDesk ID</label><input type="text" className="w-full px-4 py-3 bg-white dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium shadow-sm font-mono" placeholder="Ex: 123456789" value={eqForm.anydeskId} onChange={(e) => setEqForm({...eqForm, anydeskId: e.target.value.replace(/\D/g, '')})} /></div></div>{eqForm.status !== 'baixado' && (<div className="space-y-2 mt-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Status Atual</label><div className="flex gap-2"><button type="button" onClick={() => setEqForm({...eqForm, status: 'guardado'})} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all ${eqForm.status === 'guardado' ? 'bg-slate-800 text-white shadow-sm' : 'bg-white dark:bg-slate-800 text-slate-500 hover:bg-slate-100'}`}>Guardado / Estoque</button><button type="button" onClick={() => setEqForm({...eqForm, status: 'em_uso'})} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all ${eqForm.status === 'em_uso' ? 'bg-blue-600 text-white shadow-sm' : 'bg-white dark:bg-slate-800 text-slate-500 hover:bg-slate-100'}`}>Em Uso</button></div></div>)}</div><div className="pt-4 flex justify-end gap-3"><button type="button" onClick={() => setIsEqModalOpen(false)} className="px-6 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Cancelar</button><button type="submit" disabled={isSubmitting} className="px-6 py-3 rounded-xl font-bold text-sm bg-blue-600 text-white shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all disabled:opacity-50">{editingEqId ? 'Salvar Alterações' : 'Salvar Equipamento'}</button></div></form></div></div></div>)}

                    {isAccModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-md border dark:border-slate-800"><div className="p-6 border-b dark:border-slate-800 flex justify-between items-center"><h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><Keyboard size={20} className="text-blue-600"/> Cadastrar Novo Acessório</h3><button onClick={() => setIsAccModalOpen(false)} className="text-slate-400 hover:text-red-500 transition-colors"><X size={20}/></button></div><div className="p-6"><form onSubmit={handleSaveAccessory} className="space-y-4"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Tipo de Acessório</label><div className="relative" ref={accTypeMenuRef}><button type="button" onClick={() => setIsAccTypeMenuOpen(!isAccTypeMenuOpen)} className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm font-medium flex items-center justify-between outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><span className="truncate">{accForm.type}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isAccTypeMenuOpen ? 'rotate-180' : ''}`} /></button>{isAccTypeMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200 custom-scrollbar max-h-48 overflow-y-auto">{ACCESSORY_TYPES.map(t => (<button key={t} type="button" onClick={() => { setAccForm({...accForm, type: t}); setIsAccTypeMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{t} {accForm.type === t && <Check size={14} className="text-blue-600" />}</button>))}</div>)}</div></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Descrição / Modelo</label><input required type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: Mouse sem fio Logitech" value={accForm.name} onChange={(e) => setAccForm({...accForm, name: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Quantidade Inicial em Estoque</label><input required type="number" min="0" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" value={accForm.initialQuantity} onChange={(e) => setAccForm({...accForm, initialQuantity: e.target.value})} /></div><div className="pt-4 flex justify-end gap-3"><button type="button" onClick={() => setIsAccModalOpen(false)} className="px-5 py-2.5 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Cancelar</button><button type="submit" disabled={isSubmitting} className="px-5 py-2.5 rounded-xl font-bold text-sm bg-blue-600 text-white shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all disabled:opacity-50">Cadastrar</button></div></form></div></div></div>)}

                    {accMoveModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-md border dark:border-slate-800 overflow-hidden"><div className="p-6 border-b dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center"><div><h3 className="text-lg font-bold dark:text-white flex items-center gap-2"><ArrowLeftRight size={20} className="text-blue-600"/> Movimentar Estoque</h3><p className="text-xs text-slate-500 mt-1 font-medium">{accessories.find(a => a.id === accMoveModal)?.name || 'Acessório'}</p></div><button onClick={() => {setAccMoveModal(null); setAccMoveForm({ action: 'out', quantity: 1, unit: '', department: '', notes: '' });}} className="text-slate-400 hover:text-red-500 transition-colors"><X size={20}/></button></div><div className="p-6"><form onSubmit={handleMoveAccessory} className="space-y-4"><div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl"><button type="button" onClick={() => setAccMoveForm({...accMoveForm, action: 'in'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${accMoveForm.action === 'in' ? 'bg-white dark:bg-slate-700 text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><Plus size={14} /> Entrada (+)</button><button type="button" onClick={() => setAccMoveForm({...accMoveForm, action: 'out'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${accMoveForm.action === 'out' ? 'bg-white dark:bg-slate-700 text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><Minus size={14} /> Saída (-)</button></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Quantidade</label><input required type="number" min="1" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-lg outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-black text-center" value={accMoveForm.quantity} onChange={(e) => setAccMoveForm({...accMoveForm, quantity: e.target.value})} /></div>{accMoveForm.action === 'out' && (<div className="grid grid-cols-1 sm:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2"><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Destino (Unidade)</label><input required type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: Everest" value={accMoveForm.unit} onChange={(e) => setAccMoveForm({...accMoveForm, unit: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Destino (Setor)</label><input required type="text" className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" placeholder="Ex: RH" value={accMoveForm.department} onChange={(e) => setAccMoveForm({...accMoveForm, department: e.target.value})} /></div></div>)}<div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Observações (Opcional)</label><textarea className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium resize-none h-20" placeholder="Motivo da movimentação, para quem foi entregue..." value={accMoveForm.notes} onChange={(e) => setAccMoveForm({...accMoveForm, notes: e.target.value})} /></div><div className="pt-4"><button type="submit" disabled={isSubmitting} className={`w-full py-3.5 rounded-xl font-bold text-sm text-white shadow-lg transition-all disabled:opacity-50 ${accMoveForm.action === 'in' ? 'bg-green-600 hover:bg-green-700 shadow-green-500/20' : 'bg-orange-500 hover:bg-orange-600 shadow-orange-500/20'}`}>Confirmar Movimentação</button></div></form></div></div></div>)}

                    <header className="bg-white border-b sticky top-0 z-30 shadow-sm dark:bg-slate-900 dark:border-slate-800">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => { if (isAdmin) { setView('dashboard'); } else { setView('landing'); } setTechViewMode('active'); }}>
                            <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-500/20"><ClipboardList size={20} /></div>
                            <h1 className="text-xl font-black text-slate-800 dark:text-white tracking-tight">HelpDesk <span className="text-blue-600 font-medium">TI</span></h1>
                        </div>
                        <div className="flex items-center gap-2">
                            {isAdmin && view !== 'landing' && view !== 'login' && (
                                <>
                                <button onClick={() => setView(view === 'checklists' ? 'dashboard' : 'checklists')} className={`flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold transition-all ${view === 'checklists' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`} title="Checklists"><ListTodo size={18} /><span className="hidden md:inline">Checklists</span></button>
                                <button onClick={() => setView(view === 'kanban' ? 'dashboard' : 'kanban')} className={`flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold transition-all ${view === 'kanban' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`} title="Atividades"><Kanban size={18} /><span className="hidden md:inline">Atividades</span></button>
                                <button onClick={() => setView(view === 'inventory' ? 'dashboard' : 'inventory')} className={`flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold transition-all ${view === 'inventory' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`} title="Inventários"><Database size={18} /><span className="hidden md:inline">Inventários</span></button>
                                <button onClick={() => setView(view === 'reports' ? 'dashboard' : 'reports')} className={`flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold transition-all ${view === 'reports' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`} title="Relatórios"><BarChart3 size={18} /><span className="hidden md:inline">Relatórios</span></button>
                                </>
                            )}
                            {!isAdmin && view !== 'landing' && view !== 'new' && (<button onClick={() => setView('new')} className="flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl bg-blue-600 text-white text-xs font-bold shadow-lg shadow-blue-500/20 hover:scale-105 active:scale-95 transition-all mr-2"><PlusCircle size={18} /> <span className="hidden sm:inline">Novo Chamado</span></button>)}
                            {deferredPrompt && (<button onClick={handleInstallClick} className="p-2 rounded-xl text-blue-600 bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 transition-all animate-pulse" title="Instalar App"><Download size={20} /></button>)}
                            <button onClick={() => setIsAudioEnabled(!isAudioEnabled)} className={`p-2 rounded-xl transition-all ${isAudioEnabled ? 'text-blue-600 bg-blue-50 dark:bg-blue-900/20' : 'text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}>{isAudioEnabled ? <Volume2 size={20} /> : <VolumeX size={20} />}</button>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-xl text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                            <div className="h-6 w-[1px] bg-slate-200 mx-2 dark:bg-slate-700"></div>
                            {!isAdmin ? (<button onClick={() => setView('login')} className="flex items-center gap-2 text-xs font-bold uppercase tracking-widest px-4 py-2 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-400 transition-all"><Lock size={16} /> <span className="hidden sm:inline">TI</span></button>) : (<button onClick={handleLogout} className="flex items-center gap-2 text-xs font-bold uppercase tracking-widest px-4 py-2 rounded-xl bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 transition-all"><LogOut size={16} /> <span className="hidden sm:inline">Sair</span></button>)}
                        </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-6xl mx-auto px-4 py-8 w-full">
                        {view === 'checklists' && isAdmin && (
                          <div className="space-y-6 animate-in fade-in duration-500">
                             <div className="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border dark:border-slate-800">
                                <div><h2 className="text-2xl font-black flex items-center gap-2 dark:text-white"><ListTodo className="text-blue-600" /> Checklists</h2><p className="text-slate-500 text-sm mt-1 font-medium">Controle de tarefas rotineiras e periódicas do setor de TI.</p></div>
                                <div className="flex gap-3 w-full sm:w-auto">
                                    <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl w-full sm:w-auto overflow-x-auto">
                                        <button onClick={() => setChecklistTab('pending')} className={`flex-1 px-4 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${checklistTab === 'pending' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>Pendentes {checklists.filter(isTaskDue).length > 0 && <span className="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">{checklists.filter(isTaskDue).length}</span>}</button>
                                        <button onClick={() => setChecklistTab('all')} className={`flex-1 px-4 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${checklistTab === 'all' ? 'bg-white dark:bg-slate-700 text-slate-800 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>Todas</button>
                                    </div>
                                    <button onClick={() => { setSelectedChecklist({ title: '', description: '', assignee: '', recurrence: 'daily' }); setIsChecklistModalOpen(true); }} className="flex flex-shrink-0 items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg shadow-blue-500/20"><Plus size={16} /><span className="hidden sm:inline">Nova</span></button>
                                </div>
                             </div>
                             
                             <div className="bg-white dark:bg-slate-900 rounded-3xl shadow-sm border dark:border-slate-800 p-4 md:p-6">
                                {checklistTab === 'pending' && (
                                    <div className="space-y-3 animate-in slide-in-from-left-4">
                                        {checklists.filter(isTaskDue).length === 0 ? (
                                            <div className="py-20 text-center flex flex-col items-center opacity-60"><CheckCircle size={48} className="text-green-500 mb-4"/><p className="text-lg font-bold dark:text-white">Tudo em dia!</p><p className="text-sm text-slate-500 font-medium">Nenhuma tarefa pendente no momento.</p></div>
                                        ) : (
                                            checklists.filter(isTaskDue).map(task => (
                                                <div key={task.id} className="group flex items-start gap-4 p-4 rounded-2xl hover:bg-slate-50 dark:hover:bg-slate-800/50 border border-transparent hover:border-slate-200 dark:hover:border-slate-700 transition-all">
                                                    <button onClick={() => handleCompleteTask(task)} className="mt-1 text-slate-300 hover:text-green-500 dark:text-slate-600 dark:hover:text-green-400 transition-colors flex-shrink-0" title="Marcar como concluída"><Circle size={28} /></button>
                                                    <div className="flex-1 cursor-pointer" onClick={() => { setSelectedChecklist(task); setIsChecklistModalOpen(true); }}>
                                                        <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mb-1">
                                                            <h4 className="text-base font-bold text-slate-800 dark:text-white leading-tight group-hover:text-blue-600 transition-colors">{task.title}</h4>
                                                            <div className="flex flex-wrap items-center gap-2">
                                                                <span className="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-md bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400 flex items-center gap-1"><Repeat size={10}/>{task.recurrence === 'daily' ? 'Diário' : task.recurrence === 'weekly' ? 'Semanal' : 'Mensal'}</span>
                                                                {task.assignee && <span className="text-[10px] font-bold px-2 py-0.5 rounded-md bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 flex items-center gap-1"><User size={10}/>{task.assignee}</span>}
                                                            </div>
                                                        </div>
                                                        {task.description && <p className="text-sm text-slate-500 dark:text-slate-400 line-clamp-2 mt-1">{task.description}</p>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                {checklistTab === 'all' && (
                                    <div className="space-y-3 animate-in slide-in-from-right-4">
                                        {checklists.length === 0 ? (
                                            <div className="py-20 text-center text-slate-400 font-bold border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl">Nenhuma tarefa cadastrada.</div>
                                        ) : (
                                            checklists.map(task => {
                                                const isDue = isTaskDue(task);
                                                return (
                                                <div key={task.id} className="flex items-center justify-between p-4 rounded-2xl border dark:border-slate-800 hover:shadow-md transition-all bg-slate-50/50 dark:bg-slate-800/20">
                                                    <div className="flex items-center gap-4 flex-1 cursor-pointer" onClick={() => { setSelectedChecklist(task); setIsChecklistModalOpen(true); }}>
                                                        <div className={`p-2 rounded-xl ${isDue ? 'bg-orange-100 text-orange-600 dark:bg-orange-900/30' : 'bg-green-100 text-green-600 dark:bg-green-900/30'}`}>{isDue ? <Clock size={20}/> : <CheckSquare size={20}/>}</div>
                                                        <div>
                                                            <h4 className="text-sm font-bold text-slate-800 dark:text-white leading-tight">{task.title}</h4>
                                                            <p className="text-[10px] sm:text-xs text-slate-500 mt-1 font-medium">{task.recurrence === 'daily' ? 'Diária' : task.recurrence === 'weekly' ? 'Semanal' : 'Mensal'} • {task.assignee || 'Livre'} • {isDue ? 'Pendente' : `Feito em ${formatTimestamp(task.lastCompleted)}`}</p>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => { setSelectedChecklist(task); setIsChecklistModalOpen(true); }} className="p-2 text-slate-400 hover:text-blue-600 transition-colors ml-2"><Edit size={18}/></button>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                             </div>
                          </div>
                        )}

                        {view === 'kanban' && isAdmin && (
                          <div className="h-[calc(100vh-140px)] flex flex-col animate-in fade-in duration-500">
                             <div className="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border dark:border-slate-800">
                                <div><h2 className="text-2xl font-black flex items-center gap-2 dark:text-white"><Kanban className="text-blue-600" /> Organização TI</h2><p className="text-slate-500 text-sm mt-1 font-medium">Gestão ágil de projetos e base de conhecimento.</p></div>
                                <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl w-full sm:w-auto">
                                    <button onClick={() => setKanbanTab('board')} className={`flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${kanbanTab === 'board' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><Kanban size={16} /> Tarefas</button>
                                    <button onClick={() => setKanbanTab('kb')} className={`flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${kanbanTab === 'kb' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><BookOpen size={16} /> Informações Padrões</button>
                                </div>
                             </div>
                    
                             {kanbanTab === 'board' && (
                                 <div className="flex-1 flex gap-6 overflow-x-auto pb-4 custom-scrollbar items-start relative animate-in slide-in-from-left-4">
                                    {KANBAN_COLUMNS.map(col => (
                                       <div key={col.id} className="bg-slate-100/50 dark:bg-slate-800/30 border border-slate-200/50 dark:border-slate-800 rounded-3xl w-80 flex-shrink-0 flex flex-col max-h-full" onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, col.id)}>
                                           <div className="p-4 flex items-center justify-between border-b border-slate-200/50 dark:border-slate-800/50 bg-white/50 dark:bg-slate-900/50 rounded-t-3xl"><h3 className={`text-xs font-black uppercase tracking-widest ${col.color.split(' ')[0]} ${col.color.split(' ')[1]}`}>{col.title}</h3><span className="bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm border dark:border-slate-700">{kanbanCards.filter(c => c.status === col.id).length}</span></div>
                                           <div className="p-3 flex-1 overflow-y-auto custom-scrollbar flex flex-col gap-3">
                                              {kanbanCards.filter(c => c.status === col.id).map(card => (
                                                  <div key={card.id} draggable onDragStart={(e) => handleDragStart(e, card.id)} onClick={() => { setSelectedKanbanCard(card); setIsKanbanCardModalOpen(true); }} className="bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 cursor-grab active:cursor-grabbing hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all group">
                                                      <div className="flex justify-between items-start mb-3"><div className="flex flex-wrap gap-1">{card.assignee && <span className="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[9px] font-bold px-2 py-1 rounded-md truncate max-w-[120px]">{card.assignee}</span>}</div></div>
                                                      <h4 className="text-sm font-bold text-slate-800 dark:text-white leading-snug mb-3">{card.title}</h4>
                                                      <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400">{card.description && <span className="flex items-center gap-1"><AlignLeft size={12}/> Detalhes</span>}{card.attachments?.length > 0 && <span className="flex items-center gap-1"><Paperclip size={12}/> {card.attachments.length}</span>}{card.comments?.length > 0 && <span className="flex items-center gap-1"><MessageSquare size={12}/> {card.comments.length}</span>}</div>
                                                  </div>
                                              ))}
                                              <button onClick={() => { setSelectedKanbanCard({ title: '', description: '', assignee: '', status: col.id, comments: [] }); setIsKanbanCardModalOpen(true); }} className="w-full py-3 mt-1 rounded-2xl text-xs font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-200 dark:hover:bg-slate-800 dark:hover:text-slate-300 transition-colors flex items-center justify-center gap-2 border border-dashed border-slate-300 dark:border-slate-700"><Plus size={14}/> Adicionar Tarefa</button>
                                           </div>
                                       </div>
                                    ))}
                                 </div>
                             )}

                             {kanbanTab === 'kb' && (
                                 <div className="flex-1 overflow-y-auto animate-in slide-in-from-right-4">
                                     <div className="mb-4 flex justify-between items-center"><p className="text-xs text-slate-500 font-bold uppercase tracking-widest">Base de Conhecimento</p><button onClick={() => { setSelectedKbCard({ title: '', description: '', attachments: [] }); setIsKbCardModalOpen(true); }} className="text-xs font-bold text-blue-600 flex items-center gap-1 hover:underline"><Plus size={14}/> Adicionar Info</button></div>
                                     <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {kbCards.length === 0 ? (
                                            <div className="col-span-full py-12 text-center border-2 border-dashed rounded-3xl text-slate-400 font-bold border-slate-200 dark:border-slate-800">Nenhuma informação registrada.</div>
                                        ) : (
                                            kbCards.map(card => (
                                                <div key={card.id} onClick={() => { setSelectedKbCard(card); setIsKbCardModalOpen(true); }} className="bg-white dark:bg-slate-900 p-5 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 cursor-pointer hover:shadow-md hover:-translate-y-1 transition-all group flex flex-col h-48">
                                                    <div className="flex items-start gap-3 mb-3"><div className="p-2.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl"><BookOpen size={20}/></div><h4 className="text-sm font-bold text-slate-800 dark:text-white leading-snug flex-1 line-clamp-2">{card.title}</h4></div>
                                                    <p className="text-xs text-slate-500 dark:text-slate-400 line-clamp-3 mb-4">{card.description}</p>
                                                    <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400 mt-auto">{card.attachments?.length > 0 && <span className="flex items-center gap-1"><Paperclip size={12}/> {card.attachments.length} Anexos</span>}</div>
                                                </div>
                                            ))
                                        )}
                                     </div>
                                 </div>
                             )}
                          </div>
                        )}

                        {view === 'inventory' && isAdmin && (
                        <div className="space-y-6 animate-in fade-in zoom-in-95 duration-500">
                            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border dark:border-slate-800">
                            <div><h2 className="text-2xl font-black flex items-center gap-2 dark:text-white"><Database className="text-blue-600" /> Inventário TI</h2><p className="text-slate-500 text-sm mt-1 font-medium">Controle de equipamentos e acessórios do setor.</p></div>
                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl w-full md:w-auto overflow-x-auto custom-scrollbar">
                                <button onClick={() => setInventoryTab('equipments')} className={`flex-1 whitespace-nowrap px-4 md:px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${inventoryTab === 'equipments' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><Monitor size={16} /> Equipamentos</button>
                                <button onClick={() => setInventoryTab('accessories')} className={`flex-1 whitespace-nowrap px-4 md:px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${inventoryTab === 'accessories' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><Keyboard size={16} /> Acessórios</button>
                                <button onClick={() => setInventoryTab('decommissioned')} className={`flex-1 whitespace-nowrap px-4 md:px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${inventoryTab === 'decommissioned' ? 'bg-white dark:bg-slate-700 text-red-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}><ArchiveRestore size={16} /> Baixados</button>
                            </div>
                            </div>

                            {inventoryTab === 'equipments' && (
                            <div className="space-y-4 animate-in slide-in-from-left-4">
                                <div className="flex justify-between items-center bg-slate-900 dark:bg-slate-800 p-4 rounded-2xl shadow-sm overflow-x-auto custom-scrollbar">
                                <div className="flex gap-4 text-white min-w-max">
                                    <div className="text-center px-4 border-r border-slate-700"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Total Ativos</p><p className="text-2xl font-black">{filteredEquipments.length}</p></div>
                                    <div className="text-center px-4 border-r border-slate-700"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Em Uso</p><p className="text-2xl font-black text-blue-400">{filteredEquipments.filter(e => e.status === 'em_uso').length}</p></div>
                                    <div className="text-center px-4"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Guardados</p><p className="text-2xl font-black text-green-400">{filteredEquipments.filter(e => e.status === 'guardado').length}</p></div>
                                </div>
                                <button onClick={() => { setEditingEqId(null); setEqForm({ type: 'Notebook', model: '', specs: '', acquisitionDate: '', price: '', deviceId: '', status: 'guardado', unit: '', department: '', operator: '', anydeskId: '' }); setIsEqModalOpen(true); }} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-500/20 whitespace-nowrap ml-4"><Plus size={16} /> Novo Equipamento</button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white dark:bg-slate-900 border dark:border-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="relative md:col-span-1"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} /><input type="text" placeholder="Buscar modelo ou ID..." className="w-full pl-9 pr-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" value={eqSearchTerm} onChange={(e) => setEqSearchTerm(e.target.value)} /></div>
                                <div className="relative" ref={eqFilterMenuRef}><button onClick={() => setIsEqFilterMenuOpen(!isEqFilterMenuOpen)} className="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><Filter size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{eqTypeFilter === 'Todos' ? 'Tipo' : eqTypeFilter}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isEqFilterMenuOpen ? 'rotate-180' : ''}`} /></button>{isEqFilterMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200 max-h-60 overflow-y-auto custom-scrollbar"><button onClick={() => { setEqTypeFilter('Todos'); setIsEqFilterMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todos os Tipos {eqTypeFilter === 'Todos' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" />{EQUIPMENT_TYPES.map(t => (<button key={t} onClick={() => { setEqTypeFilter(t); setIsEqFilterMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{t} {eqTypeFilter === t && <Check size={12} className="text-blue-600" />}</button>))}</div>)}</div>
                                <div className="relative" ref={eqUnitMenuRef}><button onClick={() => setIsEqUnitMenuOpen(!isEqUnitMenuOpen)} className="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><Building2 size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{eqUnitFilter === 'Todas' ? 'Unidade' : eqUnitFilter}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isEqUnitMenuOpen ? 'rotate-180' : ''}`} /></button>{isEqUnitMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200 max-h-60 overflow-y-auto custom-scrollbar"><button onClick={() => { setEqUnitFilter('Todas'); setIsEqUnitMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todas Unidades {eqUnitFilter === 'Todas' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" />{UNIT_QUICK_FILTERS.map(u => (<button key={u} onClick={() => { setEqUnitFilter(u); setIsEqUnitMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{u} {eqUnitFilter === u && <Check size={12} className="text-blue-600" />}</button>))}</div>)}</div>
                                <div className="relative" ref={eqStatusMenuRef}><button onClick={() => setIsEqStatusMenuOpen(!isEqStatusMenuOpen)} className="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><CheckCircle size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{eqStatusFilter === 'Todos' ? 'Todos os Status' : (eqStatusFilter === 'em_uso' ? 'Em Uso' : 'Guardados')}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isEqStatusMenuOpen ? 'rotate-180' : ''}`} /></button>{isEqStatusMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200"><button onClick={() => { setEqStatusFilter('Todos'); setIsEqStatusMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todos os Status {eqStatusFilter === 'Todos' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" /><button onClick={() => { setEqStatusFilter('em_uso'); setIsEqStatusMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Apenas Em Uso {eqStatusFilter === 'em_uso' && <Check size={12} className="text-blue-600" />}</button><button onClick={() => { setEqStatusFilter('guardado'); setIsEqStatusMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Apenas Guardados {eqStatusFilter === 'guardado' && <Check size={12} className="text-blue-600" />}</button></div>)}</div>
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                {filteredEquipments.length === 0 ? (<div className="py-24 text-center border-2 border-dashed rounded-3xl text-slate-400 font-bold border-slate-200 dark:border-slate-800">Nenhum equipamento ativo encontrado.</div>) : (
                                    filteredEquipments.map(eq => (
                                    <div key={eq.id} className="bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-3xl p-5 shadow-sm hover:shadow-md transition-shadow">
                                        <div className="flex flex-col lg:flex-row gap-6 lg:items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className={`p-4 rounded-2xl ${eq.type === 'Celular' ? 'bg-purple-50 text-purple-600 dark:bg-purple-900/20' : eq.type === 'Desktop' ? 'bg-orange-50 text-orange-600 dark:bg-orange-900/20' : 'bg-blue-50 text-blue-600 dark:bg-blue-900/20'}`}>{eq.type === 'Celular' || eq.type === 'Tablet' ? <Smartphone size={28}/> : eq.type === 'Desktop' ? <Cpu size={28}/> : <Laptop size={28}/>}</div>
                                            <div><h4 className="text-lg font-black dark:text-white leading-tight">{eq.model}</h4><div className="flex items-center gap-2 mt-1"><span className="text-[10px] font-bold text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-md uppercase tracking-wider">{eq.type}</span>{eq.deviceId && <span className="text-[10px] font-mono font-bold text-slate-400 px-2 py-0.5 border dark:border-slate-700 rounded-md"><Hash size={10} className="inline mr-1 -mt-0.5"/>{eq.deviceId}</span>}</div></div>
                                        </div>
                                        <div className="flex-1 grid grid-cols-2 sm:grid-cols-3 gap-4 px-0 lg:px-6">
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">Localização</p><p className="text-xs font-bold dark:text-slate-300 truncate">{eq.unit ? `${eq.unit} - ${eq.department}` : 'Não definida'}</p></div>
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">Operador</p><p className="text-xs font-bold dark:text-slate-300 truncate" title={eq.operator}>{eq.operator || 'N/A'}</p></div>
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">AnyDesk</p><p className="text-xs font-bold dark:text-slate-300 font-mono truncate">{eq.anydeskId || 'N/A'}</p></div>
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">Especificações</p><p className="text-xs font-bold dark:text-slate-300 truncate" title={eq.specs}>{eq.specs || 'N/A'}</p></div>
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">Aquisição</p><p className="text-xs font-bold dark:text-slate-300">{formatDateBr(eq.acquisitionDate)}</p></div>
                                            <div><p className="text-[9px] font-black uppercase text-slate-400 mb-0.5">Preço</p><p className="text-xs font-bold text-green-600 dark:text-green-400">{formatCurrency(eq.price)}</p></div>
                                        </div>
                                        <div className="flex items-center gap-3 mt-4 lg:mt-0">
                                            <div className="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex items-center"><button onClick={() => handleUpdateEqStatus(eq, 'guardado')} className={`px-4 py-2 rounded-lg text-[10px] font-bold transition-all ${eq.status === 'guardado' ? 'bg-white dark:bg-slate-700 text-slate-800 dark:text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>Guardado</button><button onClick={() => handleUpdateEqStatus(eq, 'em_uso')} className={`px-4 py-2 rounded-lg text-[10px] font-bold transition-all ${eq.status === 'em_uso' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>Em Uso</button></div>
                                            <button onClick={() => handleEditEquipment(eq)} className="p-2 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl transition-colors" title="Editar Equipamento"><Edit size={18}/></button>
                                            <button onClick={() => setDecommissionEqModal(eq)} className="p-2 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-red-600 dark:hover:text-red-400 rounded-xl transition-colors" title="Dar Baixa"><Trash2 size={18}/></button>
                                            <button onClick={() => setExpandedLogId(expandedLogId === eq.id ? null : eq.id)} className="p-2 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl transition-colors" title="Ver Histórico"><History size={18}/></button>
                                        </div>
                                        </div>
                                        {expandedLogId === eq.id && (
                                        <div className="mt-4 pt-4 border-t dark:border-slate-800 animate-in slide-in-from-top-2"><h4 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">Histórico de Movimentações</h4><div className="space-y-3 max-h-40 overflow-y-auto custom-scrollbar pr-2">{[...(eq.history || [])].reverse().map((log, i) => (<div key={i} className="flex items-start gap-3"><div className="mt-1"><div className="w-1.5 h-1.5 rounded-full bg-blue-500"></div></div><div><p className="text-xs font-bold dark:text-slate-300">{log.action}</p><p className="text-[9px] font-bold text-slate-400 mt-0.5">{formatTimestamp(log.date)} • por {log.user}</p></div></div>))}</div></div>
                                        )}
                                    </div>
                                    ))
                                )}
                                </div>
                            </div>
                            )}

                            {inventoryTab === 'decommissioned' && (
                            <div className="space-y-4 animate-in slide-in-from-bottom-4">
                                <div className="flex justify-between items-center bg-slate-900 dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="flex gap-4 text-white"><div className="text-center px-4"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Equipamentos Baixados</p><p className="text-2xl font-black text-red-400">{decommissionedEquipments.length}</p></div></div>
                                </div>
                                <div className="flex bg-white dark:bg-slate-900 border dark:border-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="relative w-full md:w-full"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} /><input type="text" placeholder="Buscar equipamento baixado (modelo ou ID)..." className="w-full pl-9 pr-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" value={eqSearchTerm} onChange={(e) => setEqSearchTerm(e.target.value)} /></div>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                {decommissionedEquipments.length === 0 ? (<div className="py-24 text-center border-2 border-dashed rounded-3xl text-slate-400 font-bold border-slate-200 dark:border-slate-800">Nenhum equipamento baixado encontrado.</div>) : (
                                    decommissionedEquipments.map(eq => (
                                    <div key={eq.id} className="bg-red-50/50 dark:bg-slate-900 border border-red-200 dark:border-red-900/50 rounded-3xl p-5 shadow-sm hover:shadow-md transition-shadow">
                                        <div className="flex flex-col lg:flex-row gap-6 lg:items-center justify-between">
                                        <div className="flex items-center gap-4 opacity-80">
                                            <div className="p-4 rounded-2xl bg-red-100 text-red-600 dark:bg-red-900/30">{eq.type === 'Celular' || eq.type === 'Tablet' ? <Smartphone size={28}/> : eq.type === 'Desktop' ? <Cpu size={28}/> : <Laptop size={28}/>}</div>
                                            <div><h4 className="text-lg font-black dark:text-white leading-tight">{eq.model}</h4><div className="flex items-center gap-2 mt-1"><span className="text-[10px] font-bold text-slate-500 bg-white dark:bg-slate-800 px-2 py-0.5 rounded-md uppercase tracking-wider">{eq.type}</span>{eq.deviceId && <span className="text-[10px] font-mono font-bold text-slate-400 px-2 py-0.5 border border-red-100 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-md"><Hash size={10} className="inline mr-1 -mt-0.5"/>{eq.deviceId}</span>}</div></div>
                                        </div>
                                        <div className="flex-1"><div className="p-3 bg-red-100/50 dark:bg-red-900/10 rounded-xl border border-red-200/50 dark:border-red-900/30"><p className="text-[10px] font-black uppercase tracking-widest text-red-600 dark:text-red-400 mb-1">Motivo da Baixa</p><p className="text-sm font-medium text-slate-700 dark:text-slate-300">{eq.decommissionReason || 'Motivo não registrado'}</p><p className="text-[10px] text-slate-500 mt-2 font-medium">Baixado por {eq.decommissionUser || 'Desconhecido'} em {eq.decommissionDate ? formatDateBr(eq.decommissionDate.split('T')[0]) : 'Data não registrada'}</p></div></div>
                                        <div className="flex items-center gap-3 mt-4 lg:mt-0">
                                            <button onClick={() => handleRestoreEquipment(eq)} className="px-4 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl transition-colors text-xs font-bold flex items-center gap-2" title="Restaurar para Guardado"><ArchiveRestore size={16}/> Restaurar</button>
                                            <button onClick={() => setExpandedLogId(expandedLogId === eq.id ? null : eq.id)} className="p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-xl transition-colors" title="Ver Histórico"><History size={18}/></button>
                                        </div>
                                        </div>
                                        {expandedLogId === eq.id && (
                                        <div className="mt-4 pt-4 border-t border-red-100 dark:border-slate-800 animate-in slide-in-from-top-2"><h4 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">Histórico de Movimentações</h4><div className="space-y-3 max-h-40 overflow-y-auto custom-scrollbar pr-2">{[...(eq.history || [])].reverse().map((log, i) => (<div key={i} className="flex items-start gap-3"><div className="mt-1"><div className={`w-1.5 h-1.5 rounded-full ${log.action.includes('baixado') ? 'bg-red-500' : 'bg-slate-400'}`}></div></div><div><p className="text-xs font-bold dark:text-slate-300">{log.action}</p><p className="text-[9px] font-bold text-slate-400 mt-0.5">{formatTimestamp(log.date)} • por {log.user}</p></div></div>))}</div></div>
                                        )}
                                    </div>
                                    ))
                                )}
                                </div>
                            </div>
                            )}

                            {inventoryTab === 'accessories' && (
                            <div className="space-y-4 animate-in slide-in-from-right-4">
                                <div className="flex justify-between items-center bg-slate-900 dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="flex gap-4 text-white"><div className="text-center px-4"><p className="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Itens Encontrados</p><p className="text-2xl font-black">{filteredAccessories.length}</p></div></div>
                                <button onClick={() => setIsAccModalOpen(true)} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-500/20"><Plus size={16} /> Novo Acessório</button>
                                </div>

                                <div className="flex bg-white dark:bg-slate-900 border dark:border-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="relative w-full md:w-64" ref={accFilterMenuRef}>
                                    <button onClick={() => setIsAccFilterMenuOpen(!isAccFilterMenuOpen)} className="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><Filter size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{accTypeFilter === 'Todos' ? 'Filtrar por Tipo' : accTypeFilter}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isAccFilterMenuOpen ? 'rotate-180' : ''}`} /></button>
                                    {isAccFilterMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200 max-h-60 overflow-y-auto custom-scrollbar"><button onClick={() => { setAccTypeFilter('Todos'); setIsAccFilterMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todos os Tipos {accTypeFilter === 'Todos' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" />{ACCESSORY_TYPES.map(t => (<button key={t} onClick={() => { setAccTypeFilter(t); setIsAccFilterMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{t} {accTypeFilter === t && <Check size={12} className="text-blue-600" />}</button>))}</div>)}
                                </div>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {filteredAccessories.length === 0 ? (<div className="col-span-full py-24 text-center border-2 border-dashed rounded-3xl text-slate-400 font-bold border-slate-200 dark:border-slate-800">Nenhum acessório encontrado.</div>) : (
                                    filteredAccessories.map(acc => {
                                    const isLowStock = acc.quantity < 5;
                                    const isOut = acc.quantity === 0;
                                    return (
                                        <div key={acc.id} className={`bg-white dark:bg-slate-900 border ${isOut ? 'border-red-200 dark:border-red-900/50' : isLowStock ? 'border-orange-200 dark:border-orange-900/50' : 'dark:border-slate-800'} rounded-3xl p-5 shadow-sm flex flex-col justify-between`}>
                                        <div>
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-xl text-slate-600 dark:text-slate-300">{acc.type.includes('Mouse') ? <Mouse size={20}/> : acc.type.includes('Teclado') ? <Keyboard size={20}/> : acc.type.includes('Fone') ? <Headphones size={20}/> : <HardDrive size={20}/>}</div>
                                                <span className={`text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-md ${isOut ? 'bg-red-100 text-red-600 dark:bg-red-900/30' : isLowStock ? 'bg-orange-100 text-orange-600 dark:bg-orange-900/30' : 'bg-green-100 text-green-600 dark:bg-green-900/30'}`}>Qtd: {acc.quantity}</span>
                                            </div>
                                            <p className="text-[10px] font-black uppercase tracking-widest text-slate-400">{acc.type}</p>
                                            <h4 className="text-sm font-bold dark:text-white leading-tight mt-1 mb-4 line-clamp-2" title={acc.name}>{acc.name}</h4>
                                        </div>
                                        <div className="flex gap-2 mt-auto">
                                            <button onClick={() => setExpandedLogId(expandedLogId === acc.id ? null : acc.id)} className="p-2.5 bg-slate-50 dark:bg-slate-800 text-slate-400 hover:text-blue-600 rounded-xl transition-colors"><History size={16}/></button>
                                            <button onClick={() => setAccMoveModal(acc.id)} className="flex-1 bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-700 text-white text-xs font-bold py-2.5 rounded-xl transition-all shadow-md">Movimentar</button>
                                        </div>
                                        {expandedLogId === acc.id && (
                                            <div className="mt-4 pt-4 border-t dark:border-slate-800 animate-in zoom-in-95"><p className="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-2">Últimas 5 Movs.</p><div className="space-y-2">{[...(acc.history || [])].reverse().slice(0,5).map((log, i) => (<div key={i} className="text-[10px]"><p className={`font-bold ${log.action.includes('Entrada') ? 'text-green-600 dark:text-green-400' : 'text-orange-600 dark:text-orange-400'} leading-tight`}>{log.action}</p><p className="text-slate-400 mt-0.5">{formatTimestamp(log.date)} • {log.user}</p></div>))}</div></div>
                                        )}
                                        </div>
                                    )
                                    })
                                )}
                                </div>
                            </div>
                            )}
                        </div>
                        )}

                        {view === 'reports' && isAdmin && reportData && (
                        <div className="space-y-8 animate-in fade-in zoom-in-95 duration-500">
                            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-sm border dark:border-slate-800">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                                <h2 className="text-xl font-black flex items-center gap-2 dark:text-white"><BarChart3 className="text-blue-600" /> Relatório de Desempenho</h2>
                                <div className="flex flex-wrap gap-2">
                                <button onClick={() => setPresetDate('today')} className="px-4 py-2 rounded-2xl text-xs font-bold bg-slate-100 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors">Hoje</button>
                                <button onClick={() => setPresetDate('month')} className="px-4 py-2 rounded-2xl text-xs font-bold bg-slate-100 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors">Este Mês</button>
                                <button onClick={() => setPresetDate('year')} className="px-4 py-2 rounded-2xl text-xs font-bold bg-slate-100 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors">Este Ano</button>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row gap-4 items-end">
                                <div className="space-y-1 w-full md:w-1/3">
                                <label className="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1">Mês de Referência</label>
                                <div className="relative" ref={monthMenuRef}>
                                    <button onClick={() => setIsMonthMenuOpen(!isMonthMenuOpen)} className="w-full pl-4 pr-10 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-2xl text-sm font-bold dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all flex items-center justify-between"><span className="truncate">{selectedMonth === 'all' ? 'Todo o ano' : MONTHS[selectedMonth]}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isMonthMenuOpen ? 'rotate-180' : ''}`} /></button>
                                    {isMonthMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl max-h-60 overflow-y-auto py-1 animate-in fade-in zoom-in-95 duration-200 custom-scrollbar"><button onClick={() => { setSelectedMonth('all'); setReportFilterMode('custom'); setIsMonthMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todo o ano {selectedMonth === 'all' && <Check size={14} className="text-blue-600" />}</button>{MONTHS.map((m, i) => (<button key={i} onClick={() => { setSelectedMonth(i); setReportFilterMode('custom'); setIsMonthMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{m} {selectedMonth === i && <Check size={14} className="text-blue-600" />}</button>))}</div>)}
                                </div>
                                </div>
                                <div className="space-y-1 w-full md:w-1/3">
                                <label className="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1">Ano</label>
                                <div className="relative" ref={yearMenuRef}>
                                    <button onClick={() => setIsYearMenuOpen(!isYearMenuOpen)} className="w-full pl-4 pr-10 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-2xl text-sm font-bold dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all flex items-center justify-between"><span>{selectedYear}</span><ChevronDown size={18} className={`flex-shrink-0 transition-transform ${isYearMenuOpen ? 'rotate-180' : ''}`} /></button>
                                    {isYearMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl max-h-60 overflow-y-auto py-1 animate-in fade-in zoom-in-95 duration-200 custom-scrollbar">{availableYears.map(y => (<button key={y} onClick={() => { setSelectedYear(y); setReportFilterMode('custom'); setIsYearMenuOpen(false); }} className="w-full px-4 py-2 text-left text-sm font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{y} {selectedYear === y && <Check size={14} className="text-blue-600" />}</button>))}</div>)}
                                </div>
                                </div>
                                <div className="space-y-1 w-full md:w-1/3">
                                <label className="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1">Visualização</label>
                                <div className="relative w-full pl-12 pr-5 py-3 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center text-sm font-bold dark:text-white border border-transparent transition-all"><Calendar size={18} className="absolute left-4 text-slate-400" /><div className="flex flex-col leading-none"><span className="text-[10px] text-slate-400 uppercase tracking-wide">De</span><span>{formatDateBr(dateFilter.start)}</span></div><div className="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-3"></div><div className="flex flex-col leading-none"><span className="text-[10px] text-slate-400 uppercase tracking-wide">Até</span><span>{formatDateBr(dateFilter.end)}</span></div><input type="date" value={dateFilter.start} onChange={() => {}} className="absolute inset-0 w-full h-full opacity-0 cursor-default" disabled /></div>
                                </div>
                            </div>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div className="bg-blue-500 text-white p-6 rounded-3xl shadow-lg shadow-blue-500/20"><p className="text-blue-100 text-xs font-bold uppercase tracking-widest mb-1">Abertos</p><p className="text-4xl font-black">{reportData.total}</p></div>
                            <div className="bg-purple-500 text-white p-6 rounded-3xl shadow-lg shadow-purple-500/20"><p className="text-purple-100 text-xs font-bold uppercase tracking-widest mb-1">Solicitações</p><p className="text-4xl font-black">{reportData.requests}</p></div>
                            <div className="bg-green-500 text-white p-6 rounded-3xl shadow-lg shadow-green-500/20"><p className="text-green-100 text-xs font-bold uppercase tracking-widest mb-1">Finalizados</p><p className="text-4xl font-black">{reportData.finalized}</p></div>
                            <div className="bg-red-500 text-white p-6 rounded-3xl shadow-lg shadow-red-500/20"><p className="text-red-100 text-xs font-bold uppercase tracking-widest mb-1">Contestados</p><p className="text-4xl font-black">{reportData.contested}</p></div>
                            <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-lg shadow-slate-500/20"><p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Eficiência</p><p className="text-4xl font-black">{reportData.total > 0 ? Math.round((reportData.finalized / reportData.total) * 100) : 0}%</p></div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800"><h3 className="text-sm font-bold uppercase tracking-widest text-slate-400 mb-4 flex items-center gap-2"><Building2 size={16}/> Unidade com mais chamados</h3>{reportData.topUnit ? (<div><p className="text-2xl font-black text-slate-800 dark:text-white">{reportData.topUnit[0]}</p><p className="text-sm font-bold text-slate-500">{reportData.topUnit[1]} chamados</p></div>) : <p className="text-slate-400 font-bold">Sem dados</p>}</div>
                            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800"><h3 className="text-sm font-bold uppercase tracking-widest text-slate-400 mb-4 flex items-center gap-2"><Settings size={16}/> Setor com mais chamados</h3>{reportData.topSector ? (<div><p className="text-2xl font-black text-slate-800 dark:text-white">{reportData.topSector[0]}</p><p className="text-sm font-bold text-slate-500">{reportData.topSector[1]} chamados</p></div>) : <p className="text-slate-400 font-bold">Sem dados</p>}</div>
                            </div>
                            <div className="bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 overflow-hidden">
                            <div className="p-6 border-b dark:border-slate-800"><h3 className="font-bold text-lg dark:text-white">Produtividade da Equipe</h3></div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 dark:bg-slate-800/50 text-slate-500 uppercase text-[10px] tracking-widest font-black"><tr><th className="px-6 py-4">Técnico</th><th className="px-6 py-4">Ativos</th><th className="px-6 py-4">Finalizados</th><th className="px-6 py-4">Total</th></tr></thead>
                                <tbody className="divide-y dark:divide-slate-800">{Object.entries(reportData.techs).map(([name, stats]) => (<tr key={name} className="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors"><td className="px-6 py-4 font-bold dark:text-white">{name}</td><td className="px-6 py-4 font-bold text-blue-600">{stats.active}</td><td className="px-6 py-4 font-bold text-green-600">{stats.finalized}</td><td className="px-6 py-4 font-bold dark:text-slate-300">{stats.total}</td></tr>))}{Object.keys(reportData.techs).length === 0 && (<tr><td colSpan="4" className="px-6 py-8 text-center text-slate-400 font-bold">Nenhum registro encontrado.</td></tr>)}</tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                        )}
                        
                        {view === 'login' && (
                        <div className="max-w-md mx-auto bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-3xl p-8 shadow-2xl animate-in zoom-in-95 duration-300">
                            <div className="text-center mb-8"><div className="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600"><Lock size={32} /></div><h2 className="text-2xl font-bold dark:text-white">Painel TI</h2><p className="text-sm text-slate-500">Acesso restrito para técnicos</p></div>
                            <form onSubmit={handleLogin} className="space-y-4">
                            <div className="relative"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="Nome de usuário" className="w-full pl-12 pr-5 py-3 border rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-4 focus:ring-blue-500/10 font-bold transition-all" value={loginForm.email} onChange={(e) => setLoginForm({...loginForm, email: e.target.value})} disabled={isLoggingIn} /></div>
                            <div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input type="password" placeholder="Senha" className="w-full pl-12 pr-5 py-3 border rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-4 focus:ring-blue-500/10 font-bold transition-all" value={loginForm.password} onChange={(e) => setLoginForm({...loginForm, password: e.target.value})} disabled={isLoggingIn} /></div>
                            {loginError && <p className="text-red-500 text-xs text-center font-bold">Falha na autenticação.</p>}
                            <button disabled={isLoggingIn} className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-xl shadow-blue-500/20 disabled:opacity-70 disabled:cursor-not-allowed">{isLoggingIn ? <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div> : 'Entrar'}</button>
                            <button type="button" onClick={() => setView('landing')} className="w-full text-slate-400 text-sm font-bold py-2" disabled={isLoggingIn}>Voltar</button>
                            </form>
                        </div>
                        )}

                        {view === 'landing' && (
                            <div className="max-w-4xl mx-auto py-12 animate-in fade-in zoom-in-95 duration-500">
                            <div className="text-center mb-12"><h2 className="text-3xl md:text-4xl font-black mb-4 dark:text-white">Olá! Como podemos <span className="text-blue-600">ajudar hoje?</span></h2><p className="text-slate-500 dark:text-slate-400 font-medium">Selecione uma das opções abaixo para prosseguir com seu atendimento.</p></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button onClick={() => setView('new')} className="group relative bg-white dark:bg-slate-900 border dark:border-slate-800 p-8 rounded-[2rem] shadow-sm hover:shadow-2xl hover:shadow-blue-500/10 transition-all hover:-translate-y-2 text-left overflow-hidden"><div className="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity"><PlusCircle size={120} className="text-blue-600" /></div><div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform"><PlusCircle size={32} /></div><h3 className="text-2xl font-bold dark:text-white mb-2">Abrir Novo Chamado</h3><p className="text-slate-500 dark:text-slate-400 text-sm mb-6 font-medium">Está com algum problema técnico? Clique aqui para registrar uma nova solicitação.</p><div className="flex items-center gap-2 text-blue-600 font-bold text-sm uppercase tracking-widest">Começar agora <ChevronRight size={16} /></div></button>
                            <button onClick={() => setView('dashboard')} className="group relative bg-white dark:bg-slate-900 border dark:border-slate-800 p-8 rounded-[2rem] shadow-sm hover:shadow-2xl hover:shadow-blue-500/10 transition-all hover:-translate-y-2 text-left overflow-hidden"><div className="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity"><Search size={120} className="text-slate-600" /></div><div className="w-16 h-16 bg-slate-800 dark:bg-slate-700 text-white rounded-2xl flex items-center justify-center mb-6 shadow-lg group-hover:scale-110 transition-transform"><ClipboardList size={32} /></div><h3 className="text-2xl font-bold dark:text-white mb-2">Meus Chamados</h3><p className="text-slate-500 dark:text-slate-400 text-sm mb-6 font-medium">Acompanhe o status e converse com o suporte sobre seus chamados já abertos.</p><div className="flex items-center gap-2 text-slate-800 dark:text-slate-200 font-bold text-sm uppercase tracking-widest">Ver histórico <ChevronRight size={16} /></div></button>
                            </div>
                        </div>
                        )}

                        {view === 'new' && (
                            <div className="max-w-2xl mx-auto bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-3xl p-8 shadow-sm animate-in slide-in-from-bottom-10 duration-500">
                            <h2 className="text-2xl font-bold mb-8 flex items-center gap-3 text-blue-600"><PlusCircle /> Abertura de Chamado</h2>
                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-2xl mb-8"><button type="button" onClick={() => setTicketType('problem')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all ${ticketType === 'problem' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}><Wrench size={18} /> Problema Técnico</button><button type="button" onClick={() => setTicketType('request')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all ${ticketType === 'request' ? 'bg-white dark:bg-slate-700 text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}><PackagePlus size={18} /> Solicitação</button></div>
                            <form onSubmit={handleCreateTicket} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Building2 size={12} /> Unidade</label><div className="relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input required className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.unit} onChange={(e) => setFormData({...formData, unit: e.target.value})} placeholder="Ex: Everest" /></div></div><div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Settings size={12} /> Setor</label><div className="relative"><Settings className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input required className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.department} onChange={(e) => setFormData({...formData, department: e.target.value})} placeholder="Ex: Comercial" /></div></div></div>
                            <div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><User size={12} /> Solicitante</label><div className="relative"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input required className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.requester} onChange={(e) => setFormData({...formData, requester: e.target.value})} placeholder="Seu nome" /></div></div>
                            {ticketType === 'problem' && (<><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Laptop size={12} /> Equipamento / Operador</label><div className="relative"><Laptop className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={formData.machineName} onChange={(e) => setFormData({...formData, machineName: e.target.value})} placeholder="Ex: PC-CONTABIL-01" /></div></div><div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Hash size={12} /> AnyDesk</label><div className="relative"><Hash className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 font-mono transition-all" value={formData.anydeskId} onChange={(e) => setFormData({...formData, anydeskId: e.target.value.replace(/\D/g, '')})} placeholder="ID de acesso" /></div></div></div><div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Clock size={12} /> Horário para Atendimento</label><div className="relative" ref={timeMenuRef}><button type="button" onClick={() => setIsTimeMenuOpen(!isTimeMenuOpen)} className="w-full px-5 py-3 border rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white flex items-center justify-between font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all"><div className="flex items-center gap-3"><Clock size={18} className="text-slate-400" /><span>{formData.accessTime}</span></div><ChevronDown size={18} className={`transition-transform text-slate-400 ${isTimeMenuOpen ? 'rotate-180' : ''}`} /></button>{isTimeMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200"><div className="max-h-60 overflow-y-auto py-2 custom-scrollbar">{TIME_OPTIONS.map((time) => (<button key={time} type="button" onClick={() => { setFormData({...formData, accessTime: time}); setIsTimeMenuOpen(false); }} className="w-full px-6 py-2.5 text-left text-sm font-semibold hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors flex items-center justify-between"><span className={formData.accessTime === time ? 'text-blue-600' : 'text-slate-600 dark:text-slate-300'}>{time}</span>{formData.accessTime === time && <Check size={14} className="text-blue-600" />}</button>))}</div></div>)}</div></div></>)}
                            <div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><StickyNote size={12} /> {ticketType === 'request' ? 'O que você precisa?' : 'Descrição do Problema'}</label><div className="relative"><AlignLeft className="absolute left-4 top-4 text-slate-400" size={18} /><textarea required rows="4" className="w-full pl-12 pr-4 py-3 border rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-all" value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} placeholder={ticketType === 'request' ? "Descreva o item ou acesso que você precisa..." : "O que está acontecendo?"} /></div></div>
                            <div className="flex gap-4 pt-2"><button disabled={isSubmitting} className="flex-1 flex justify-center items-center gap-2 bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition-all uppercase text-xs tracking-widest shadow-lg shadow-blue-500/20 active:scale-95 disabled:opacity-50">{isSubmitting ? <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div> : 'Enviar Chamado'}</button><button type="button" onClick={() => setView('landing')} className="px-8 border rounded-2xl font-bold dark:border-slate-700 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all uppercase text-xs">Voltar</button></div>
                            </form>
                        </div>
                        )}

                        {(view === 'dashboard' || view === 'archive') && (
                        <div className="space-y-6 animate-in fade-in duration-500">
                            {!isAdmin && (!userSector || !userUnit) ? (
                            <div className="max-w-md mx-auto bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-3xl p-8 shadow-sm">
                                <div className="text-center mb-6"><div className="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600 shadow-sm"><Users size={24} /></div><h3 className="text-xl font-bold dark:text-white">Identificação Necessária</h3><p className="text-xs text-slate-500 mt-1">Informe seus dados para localizar seus chamados.</p></div>
                                <div className="space-y-4">
                                <div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Building2 size={12} /> Unidade</label><div className="relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full pl-12 pr-4 py-3 border rounded-2xl dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={unitInput} onChange={(e) => setUnitInput(e.target.value)} placeholder="Ex: Everest" /></div></div>
                                <div className="space-y-2"><label className="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1 flex items-center gap-1.5"><Monitor size={12} /> Setor</label><div className="relative"><Settings className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full pl-12 pr-4 py-3 border rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={sectorInput} onChange={(e) => setSectorInput(e.target.value)} placeholder="Ex: Comercial" /></div></div>
                                <button onClick={handleAccessConfirm} disabled={isAccessing} className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3.5 rounded-2xl hover:bg-blue-700 transition-all uppercase text-[10px] tracking-widest shadow-lg shadow-blue-500/20 disabled:opacity-70 disabled:cursor-not-allowed">{isAccessing ? <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> : 'Acessar Painel'}</button>
                                <button onClick={() => setView('landing')} className="w-full text-slate-400 text-xs font-bold py-2">Voltar ao Início</button>
                                </div>
                            </div>
                            ) : (
                                <>
                                {isAdmin && view === 'dashboard' && (
                                <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-3xl p-8 shadow-lg shadow-blue-900/20 relative overflow-hidden animate-in fade-in slide-in-from-top-4 duration-500">
                                    <div className="relative z-10 text-white"><h2 className="text-3xl font-black mb-2">Olá, {techName}!</h2><p className="text-blue-100 font-medium text-lg italic opacity-90">"{dailyPhrase}"</p></div>
                                    <div className="absolute right-0 bottom-0 p-6 opacity-10 text-white transform rotate-12 translate-y-4 translate-x-4"><ClipboardList size={140} /></div>
                                </div>
                                )}
                                
                                <div className="flex flex-wrap items-center gap-3">
                                {isAdmin ? (
                                    <>
                                    <div className="bg-slate-900 dark:bg-blue-600 text-white px-4 py-2 rounded-2xl flex items-center gap-3 shadow-sm border border-transparent w-fit animate-in slide-in-from-left-4"><UserCheck size={18} className="text-blue-400 dark:text-blue-100" /><div className="leading-tight"><p className="text-[9px] font-black uppercase opacity-60 tracking-widest">Painel TI Ativo</p><p className="font-bold text-xs">{techName}</p></div></div>
                                    <div className="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-2xl shadow-inner overflow-x-auto custom-scrollbar">
                                        <button onClick={() => { setView('dashboard'); setTechViewMode('active'); }} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${view === 'dashboard' && techViewMode === 'active' ? 'bg-white dark:bg-slate-700 shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Meus/Novos {activeCount > 0 && <span className="bg-blue-600 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">{activeCount}</span>}</button>
                                        <button onClick={() => { setView('dashboard'); setTechViewMode('others'); }} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${view === 'dashboard' && techViewMode === 'others' ? 'bg-white dark:bg-slate-700 shadow text-purple-600' : 'text-slate-500 hover:text-slate-700'}`}>Em Atendimento {othersCount > 0 && <span className="bg-purple-500 text-white text-[9px] px-1.5 py-0.5 rounded-full ml-1">{othersCount}</span>}</button>
                                        <button onClick={() => { setView('dashboard'); setTechViewMode('contested'); }} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 whitespace-nowrap ${view === 'dashboard' && techViewMode === 'contested' ? 'bg-white dark:bg-slate-700 shadow text-red-600' : 'text-slate-500 hover:text-slate-700'}`}>Contestações {contestedCount > 0 && <span className="bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded-full">{contestedCount}</span>}</button>
                                    </div>
                                    <button onClick={() => setView(view === 'archive' ? 'dashboard' : 'archive')} className={`flex items-center gap-2 px-5 py-2.5 rounded-2xl text-xs font-bold transition-all border shadow-sm whitespace-nowrap ${view === 'archive' ? 'bg-blue-600 text-white border-transparent' : 'bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'}`}><Archive size={16} /><span className="hidden sm:inline">Chamados Finalizados</span><span className="sm:hidden">Finalizados</span></button>
                                    </>
                                ) : (
                                    <div className="bg-white dark:bg-slate-900 border dark:border-slate-800 p-4 rounded-2xl flex items-center justify-between w-full shadow-sm">
                                    <div className="flex items-center gap-4"><div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl"><Users className="text-blue-600" /></div><div><p className="text-[10px] font-black uppercase tracking-widest text-slate-400">Sua Localização</p><p className="font-bold text-sm">{formatDisplay(userUnit)} — {formatDisplay(userSector)}</p></div></div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setUserUnit(''); setUserSector(''); localStorage.removeItem('helpdesk_user_unit'); localStorage.removeItem('helpdesk_user_sector'); }} className="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">Trocar Dados</button>
                                        <button onClick={() => setView(view === 'archive' ? 'dashboard' : 'archive')} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${view === 'archive' ? 'bg-blue-600 text-white border-transparent' : 'bg-slate-100 dark:bg-slate-800 dark:border-slate-700'}`}>{view === 'archive' ? 'Ver Ativos' : 'Ver Finalizados'}</button>
                                    </div>
                                    </div>
                                )}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-5 gap-4 bg-white dark:bg-slate-900 border dark:border-slate-800 p-4 rounded-2xl shadow-sm">
                                <div className="relative md:col-span-2"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input type="text" placeholder="Pesquisar nos chamados..." className="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 dark:text-white font-medium" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                {isAdmin && (
                                    <>
                                    <div className="relative" ref={unitMenuRef}>
                                        <button onClick={() => setIsUnitMenuOpen(!isUnitMenuOpen)} className="w-full h-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><Building2 size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{unitFilter === 'Todas' ? 'Unidades' : unitFilter}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isUnitMenuOpen ? 'rotate-180' : ''}`} /></button>
                                        {isUnitMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200"><button onClick={() => { setUnitFilter('Todas'); setIsUnitMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todas Unidades {unitFilter === 'Todas' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" />{UNIT_QUICK_FILTERS.map(u => (<button key={u} onClick={() => { setUnitFilter(u); setIsUnitMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{u} {unitFilter === u && <Check size={12} className="text-blue-600" />}</button>))}</div>)}
                                    </div>
                                    <div className="relative" ref={priorityMenuRef}>
                                        <button onClick={() => setIsPriorityMenuOpen(!isPriorityMenuOpen)} className="w-full h-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><ArrowUpCircle size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{priorityFilter === 'Todas' ? 'Prioridade' : PRIORITY_OPTIONS.find(p => p.id === priorityFilter)?.label}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isPriorityMenuOpen ? 'rotate-180' : ''}`} /></button>
                                        {isPriorityMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200"><button onClick={() => { setPriorityFilter('Todas'); setIsPriorityMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todas Prioridades {priorityFilter === 'Todas' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" />{PRIORITY_OPTIONS.map(p => (<button key={p.id} onClick={() => { setPriorityFilter(p.id); setIsPriorityMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">{p.label} {priorityFilter === p.id && <Check size={12} className="text-blue-600" />}</button>))}</div>)}
                                    </div>
                                    <div className="relative" ref={typeMenuRef}>
                                        <button onClick={() => setIsTypeMenuOpen(!isTypeMenuOpen)} className="w-full h-full px-4 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-xs font-bold flex items-center justify-between gap-2 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-white"><div className="flex items-center gap-2 overflow-hidden"><Layers size={16} className="text-blue-500 flex-shrink-0" /><span className="truncate">{typeFilter === 'Todos' ? 'Tipo' : (typeFilter === 'problem' ? 'Problemas' : 'Solicitações')}</span></div><ChevronDown size={14} className={`transition-transform flex-shrink-0 ${isTypeMenuOpen ? 'rotate-180' : ''}`} /></button>
                                        {isTypeMenuOpen && (<div className="absolute z-50 mt-2 w-full bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-2xl overflow-hidden py-1 animate-in fade-in zoom-in-95 duration-200"><button onClick={() => { setTypeFilter('Todos'); setIsTypeMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Todos Tipos {typeFilter === 'Todos' && <Check size={12} className="text-blue-600" />}</button><div className="h-px bg-slate-100 dark:bg-slate-800 mx-2 my-1" /><button onClick={() => { setTypeFilter('problem'); setIsTypeMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Problemas Técnicos {typeFilter === 'problem' && <Check size={12} className="text-blue-600" />}</button><button onClick={() => { setTypeFilter('request'); setIsTypeMenuOpen(false); }} className="w-full px-4 py-2 text-left text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20 dark:text-white flex items-center justify-between">Solicitações {typeFilter === 'request' && <Check size={12} className="text-blue-600" />}</button></div>)}
                                    </div>
                                    </>
                                )}
                                </div>

                                {loading ? (<div className="py-20 flex justify-center"><div className="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>) : filteredTickets.length === 0 ? (<div className="py-24 text-center border-2 border-dashed rounded-3xl text-slate-400 font-bold border-slate-200 dark:border-slate-800">Nenhum chamado encontrado nesta categoria.</div>) : (
                                <div className="space-y-4">
                                    {isAdmin && (
                                        <div className="grid grid-cols-2 md:grid-cols-12 gap-4 px-6 py-2 text-[10px] font-black uppercase text-slate-400 tracking-widest select-none hidden md:grid">
                                            <div className="md:col-span-8 flex justify-between"><span>Detalhes do Chamado</span><span className="mr-8">Data Abertura</span></div>
                                            <div className="md:col-span-4 pl-4">Status & Gestão</div>
                                        </div>
                                    )}
                                    {filteredTickets.map(ticket => {
                                        const status = STATUS_OPTIONS.find(s => s.id === ticket.status) || STATUS_OPTIONS[0];
                                        const priority = PRIORITY_OPTIONS.find(p => p.id === ticket.priority) || PRIORITY_OPTIONS[0];
                                        const isExpanded = expandedChatId === ticket.id;
                                        const hasPublicUnread = hasUnreadMessages(ticket);
                                        const hasInternalUnread = hasUnreadInternal(ticket);
                                        const StatusIcon = status.icon;
                                        const PriorityIcon = priority.icon;
                                        const isOwner = ticket.technician === techName;
                                        const isPending = ticket.technician === 'Pendente';
                                        const isAssignedToOther = !isOwner && !isPending && ticket.technician;
                                        const isLockedForTech = isAdmin && isAssignedToOther && ticket.status !== 'finalizado';
                                        const isFinalized = ticket.status === 'finalizado';
                                        const ticketTitle = ticket.type === 'request' ? 'Solicitação de Equipamento/Acesso' : 'Problema Técnico';
                                        const TicketTypeIcon = ticket.type === 'request' ? PackagePlus : Wrench;

                                        return (
                                            <div key={ticket.id} id={`ticket-${ticket.id}`} className={`bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-3xl overflow-hidden transition-all hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-none animate-in slide-in-from-bottom-5 ${ticket.status === 'contestado' ? 'border-red-300 dark:border-red-900/50' : ''}`}>
                                            {isLockedForTech && !isFinalized && (<div className="bg-slate-100 dark:bg-slate-800 px-6 py-2 text-xs font-bold text-slate-500 flex items-center gap-2 border-b dark:border-slate-700"><Lock size={12} /> Chamado em atendimento por: {ticket.technician}</div>)}
                                            {isFinalized && (<div className="bg-slate-50 dark:bg-slate-800/50 px-6 py-2 text-xs font-bold text-slate-400 flex items-center gap-2 border-b dark:border-slate-700"><Lock size={12} /> Chamado finalizado (Modo de Leitura)</div>)}
                                            
                                            <div className={`p-6 ${isLockedForTech || isFinalized ? 'opacity-75' : ''}`}>
                                                <div className="flex flex-wrap items-center justify-between gap-4 mb-6">
                                                <div className="flex flex-wrap gap-2">
                                                    <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase flex items-center gap-1.5 ${status.color}`}><StatusIcon size={12} /> {status.label}</span>
                                                    <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase flex items-center gap-1.5 ${priority.color}`}><PriorityIcon size={12} /> {priority.label}</span>
                                                    <span className="px-3 py-1 rounded-full text-[10px] font-mono font-bold bg-slate-100 dark:bg-slate-800 text-slate-500">#{ticket.id.substring(0,6)}</span>
                                                </div>
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><Calendar size={12} /> {formatTimestamp(ticket.createdAt)}</p>
                                                </div>
                                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                                <div className={`${isAdmin ? 'lg:col-span-8' : 'lg:col-span-12'} space-y-6`}>
                                                    <div className="flex flex-col gap-2">
                                                        <h3 className="text-xl font-black dark:text-white leading-tight flex items-center gap-2 text-slate-800"><TicketTypeIcon className="text-blue-600" size={24} />{ticketTitle}</h3>
                                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border dark:border-slate-800 mt-2"><p className="text-xs font-bold text-slate-400 uppercase mb-1">Detalhes da Solicitação</p><p className="text-sm text-slate-600 dark:text-slate-300 font-medium leading-relaxed whitespace-pre-wrap">{ticket.description}</p></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-3 gap-4">
                                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border dark:border-slate-800"><p className="text-[9px] font-black uppercase text-slate-400 mb-1 flex items-center gap-1"><User size={10} /> Solicitante</p><p className="text-xs font-bold">{formatName(ticket.requester)}</p></div>
                                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border dark:border-slate-800"><p className="text-[9px] font-black uppercase text-slate-400 mb-1 flex items-center gap-1"><Building2 size={10} /> Localização</p><p className="text-xs font-bold truncate">{formatDisplay(ticket.unit)} — {formatDisplay(ticket.department)}</p></div>
                                                    {ticket.type !== 'request' && (
                                                        <><div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border dark:border-slate-800"><p className="text-[9px] font-black uppercase text-slate-400 mb-1 flex items-center gap-1"><Laptop size={10} /> Equipamento</p><p className="text-xs font-bold truncate">{ticket.machineName || '---'}</p></div>
                                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border dark:border-slate-800"><p className="text-[9px] font-black uppercase text-slate-400 mb-1 flex items-center gap-1"><Hash size={10} /> AnyDesk</p><p className="text-xs font-bold font-mono">{ticket.anydeskId || '---'}</p></div>
                                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border dark:border-slate-800"><p className="text-[9px] font-black uppercase text-slate-400 mb-1 flex items-center gap-1"><Clock size={10} /> Horário Pref.</p><p className="text-xs font-bold">{ticket.accessTime || 'Livre'}</p></div></>
                                                    )}
                                                    <div className="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-2xl border border-blue-100 dark:border-blue-900/30"><p className="text-[9px] font-black uppercase text-blue-400 mb-1 flex items-center gap-1"><UserPlus size={10} /> Atendimento</p><p className="text-xs font-bold text-blue-600">{ticket.technician || 'Aguardando'}</p></div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                    <button onClick={() => { 
                                                        if (isExpanded) { setExpandedChatId(null); } 
                                                        else { setExpandedChatId(ticket.id); setActiveChatTab('public'); markAsRead(ticket.id, 'public'); }
                                                    }} className={`relative flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold transition-all ${isExpanded ? 'bg-blue-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}`}>
                                                        <MessageSquare size={16} /> Mensagens
                                                        {!isExpanded && hasPublicUnread && !hasInternalUnread && (<div className="absolute -top-1.5 -right-1.5 p-1 rounded-full border-2 border-white dark:border-slate-900 bg-blue-600 shadow-md animate-bounce"><Bell size={10} className="text-white fill-current" /></div>)}
                                                        {!isExpanded && !hasPublicUnread && hasInternalUnread && (<div className="absolute -top-1.5 -right-1.5 p-1 rounded-full border-2 border-white dark:border-slate-900 bg-orange-500 shadow-md animate-bounce"><Bell size={10} className="text-white fill-current" /></div>)}
                                                        {!isExpanded && hasPublicUnread && hasInternalUnread && (<div className="absolute -top-1.5 -right-1.5 flex -space-x-1 animate-bounce"><div className="p-1 rounded-full border-2 border-white dark:border-slate-900 bg-blue-600 shadow-md z-10"><Bell size={8} className="text-white fill-current" /></div><div className="p-1 rounded-full border-2 border-white dark:border-slate-900 bg-orange-500 shadow-md z-0"><Bell size={8} className="text-white fill-current" /></div></div>)}
                                                    </button>
                                                    <button onClick={() => setShowHistoryId(showHistoryId === ticket.id ? null : ticket.id)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"><History size={16} /> Ver Log</button>
                                                    {!isAdmin && ticket.status === 'finalizado' && (<button onClick={() => requestContestTicket(ticket.id)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-100 dark:border-red-800 hover:bg-red-100 dark:hover:bg-red-900/40 transition-all"><AlertTriangle size={16} /> Contestar Solução</button>)}
                                                    {isAdmin && !isFinalized && (<>{isPending && (<button onClick={() => updateTicketData(ticket.id, { technician: techName, status: 'atendimento' }, `${techName} assumiu o chamado`)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800 hover:bg-green-100 dark:hover:bg-green-900/40 transition-all"><UserPlus size={16} /> Assumir Chamado</button>)}
                                                        {isLockedForTech && (<button onClick={() => updateTicketData(ticket.id, { technician: techName, status: 'atendimento' }, `${techName} assumiu o chamado que estava com ${ticket.technician}`)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 border border-purple-200 dark:border-purple-800 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-all"><UserPlus size={16} /> Assumir Chamado</button>)}
                                                        {isOwner && ticket.status !== 'finalizado' && (<button onClick={() => updateTicketData(ticket.id, { technician: 'Pendente' }, `${techName} devolveu o chamado para a fila`)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-bold bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 border border-orange-200 dark:border-orange-800 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-all"><UserMinus size={16} /> Devolver para Fila</button>)}</>
                                                    )}
                                                    </div>
                                                </div>
                                                {isAdmin && (
                                                    <div className={`lg:col-span-4 bg-slate-50 dark:bg-slate-800/30 rounded-3xl p-6 border dark:border-slate-800 space-y-4 ${isLockedForTech || isFinalized ? 'pointer-events-none opacity-50' : ''}`}>
                                                    <p className="text-[10px] font-black uppercase text-blue-600 tracking-widest flex items-center gap-2"><Settings size={14}/> Gestão Operacional</p>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {STATUS_OPTIONS.map(opt => {
                                                        if (opt.id === 'contestado') return null;
                                                        return (<button key={opt.id} disabled={isLockedForTech || isFinalized} onClick={() => { const updates = { status: opt.id }; if (opt.id === 'atendimento') { updates.technician = techName; } updateTicketData(ticket.id, updates, `Status: ${opt.label}`); }} className={`px-2 py-2 rounded-xl text-[10px] font-bold border transition-all ${ticket.status === opt.id ? 'bg-blue-600 text-white border-transparent shadow-sm shadow-blue-500/20' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{opt.label}</button>);
                                                        })}
                                                    </div>
                                                    <label className="text-[9px] font-black uppercase text-slate-400 flex items-center gap-1 tracking-widest mt-2"><AlertCircle size={10} /> Prioridade</label>
                                                    <div className="flex gap-2">{PRIORITY_OPTIONS.map(opt => (<button key={opt.id} disabled={isLockedForTech || isFinalized} onClick={() => updateTicketData(ticket.id, { priority: opt.id }, `Prioridade: ${opt.label}`)} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold border transition-all ${ticket.priority === opt.id ? 'bg-slate-900 dark:bg-slate-600 text-white border-transparent shadow-sm' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{opt.label}</button>))}</div>
                                                    <div className="space-y-2"><label className="text-[9px] font-black uppercase text-slate-400 flex items-center gap-1 tracking-widest"><StickyNote size={10} /> Notas Técnicas</label><textarea disabled={isLockedForTech || isFinalized} className="w-full p-3 bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-xl text-xs font-medium outline-none focus:ring-1 focus:ring-blue-500 h-24 resize-none transition-all" placeholder="Notas internas..." defaultValue={ticket.notes} onBlur={(e) => updateTicketData(ticket.id, { notes: e.target.value })} /></div>
                                                    </div>
                                                )}
                                                </div>
                                                {showHistoryId === ticket.id && (
                                                <div className="mt-8 pt-8 border-t dark:border-slate-800 animate-in slide-in-from-top-4">
                                                    <h4 className="text-xs font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><History size={14} /> Log de Alterações</h4>
                                                    <div className="space-y-4 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                                    {ticket.history?.map((log, i) => (<div key={i} className="flex gap-4"><div className="flex flex-col items-center"><div className="w-2 h-2 rounded-full bg-blue-500 mt-1"></div>{i !== ticket.history.length - 1 && <div className="w-[1px] flex-1 bg-slate-200 dark:bg-slate-800"></div>}</div><div className="pb-4"><p className="text-xs font-bold leading-none dark:text-slate-200">{log.label}</p><div className="flex gap-4 mt-2"><span className="text-[10px] text-slate-400 flex items-center gap-1 font-medium"><Clock size={10} /> {formatTimestamp({toDate: () => new Date(log.timestamp)})}</span><span className="text-[10px] text-slate-400 flex items-center gap-1 font-medium"><User size={10} /> {log.user}</span></div></div></div>))}
                                                    </div>
                                                </div>
                                                )}
                                                {isExpanded && (
                                                <div className="mt-8 pt-8 border-t dark:border-slate-800 animate-in zoom-in-95">
                                                    <div className="flex items-center justify-between mb-4">
                                                    <h4 className="text-xs font-black uppercase tracking-widest text-blue-600 flex items-center gap-2"><MessageCircle size={14} /> Canal de Comunicação</h4>
                                                    {isAdmin && (<div className="flex bg-slate-100 dark:bg-slate-800/50 p-1 rounded-xl"><button onClick={() => { setActiveChatTab('public'); markAsRead(ticket.id, 'public'); }} className={`relative px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all ${activeChatTab === 'public' ? 'bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Público{hasPublicUnread && <div className="absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-blue-600 animate-pulse"></div>}</button><button onClick={() => { setActiveChatTab('internal'); markAsRead(ticket.id, 'internal'); }} className={`relative px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all flex items-center gap-1.5 ${activeChatTab === 'internal' ? 'bg-white dark:bg-slate-700 text-orange-600 dark:text-orange-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}><EyeOff size={12} /> Interno{hasInternalUnread && <div className="absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-orange-500 animate-pulse"></div>}</button></div>)}
                                                    </div>
                                                    <div className={`rounded-3xl p-4 mb-4 max-h-[400px] overflow-y-auto space-y-4 shadow-inner scroll-smooth custom-scrollbar ${activeChatTab === 'internal' ? 'bg-orange-50/50 dark:bg-orange-900/10 border-orange-100 dark:border-orange-900/30 border' : 'bg-slate-100/50 dark:bg-slate-950/30'}`}>
                                                    {((activeChatTab === 'internal') ? ticket.internalMessages : ticket.messages)?.length > 0 ? (((activeChatTab === 'internal') ? ticket.internalMessages : ticket.messages).map((m, idx) => (
                                                        <div key={idx} className={`flex flex-col ${m.senderRole === 'tech' ? 'items-start' : 'items-end'}`}>
                                                            <span className="text-[10px] font-bold text-slate-400 mb-1 px-2">{m.sender} • {formatTimestamp({toDate: () => new Date(m.timestamp)})}</span>
                                                            <div className={`max-w-[85%] px-4 py-2.5 rounded-2xl text-sm shadow-sm transition-all overflow-hidden ${m.senderRole === 'tech' ? (activeChatTab === 'internal' ? 'bg-orange-100 text-orange-900' : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100') : 'bg-blue-600 text-white shadow-lg shadow-blue-500/10'}`}>
                                                                {m.image && (<div className="mb-2 -mx-2 -mt-2 group relative cursor-zoom-in" onClick={() => openImageViewer(m.image, ticket)}><img src={m.image} alt="Anexo" className="w-full h-auto rounded-t-xl max-h-60 object-cover" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center"><Maximize2 className="text-white opacity-0 group-hover:opacity-100 drop-shadow-md" size={24} /></div></div>)}
                                                                {m.text && <p className="whitespace-pre-wrap break-words">{m.text}</p>}
                                                            </div>
                                                        </div>
                                                    ))) : (<div className="py-12 text-center text-slate-400 font-bold text-[10px] uppercase tracking-widest italic opacity-60">Nenhuma mensagem registrada</div>)}
                                                    <div ref={chatEndRef} />
                                                    </div>
                                                    <div className="relative">
                                                        {chatImageFile && (<div className="absolute bottom-full left-0 mb-2 p-2 bg-white dark:bg-slate-800 rounded-xl shadow-lg border dark:border-slate-700 animate-in slide-in-from-bottom-2"><div className="relative"><img src={chatImagePreview} alt="Preview" className="h-20 w-auto rounded-lg object-cover" /><button onClick={() => { setChatImageFile(null); setChatImagePreview(null); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-md"><X size={12} /></button></div></div>)}
                                                        <form onSubmit={(e) => { e.preventDefault(); const input = e.target.message; sendChatMessage(ticket.id, input.value, activeChatTab === 'internal'); input.value = ''; input.style.height = 'auto'; }} className="flex gap-2 items-end">
                                                        {(!isLockedForTech || (activeChatTab === 'internal' && !isFinalized)) && !isFinalized && (<><div className="flex-1 relative"><textarea name="message" placeholder="Escreva sua mensagem..." rows="1" className="w-full bg-white dark:bg-slate-800 pl-6 pr-12 py-3 rounded-2xl border dark:border-slate-700 outline-none focus:ring-2 focus:ring-blue-500 font-medium transition-all dark:text-white resize-none overflow-hidden" style={{ minHeight: '50px', maxHeight: '160px' }} onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = `${e.target.scrollHeight}px`; }} onPaste={handlePaste} /><input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImageSelect} /><button type="button" onClick={() => fileInputRef.current?.click()} disabled={isCompressing} className={`absolute right-3 bottom-3 p-2 rounded-xl text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-700 transition-all ${isCompressing ? 'animate-pulse' : ''}`} title="Anexar imagem">{isCompressing ? <Clock size={20} /> : <Paperclip size={20} />}</button></div><button className={`p-3 rounded-2xl text-white shadow-lg active:scale-95 transition-all mb-1 ${activeChatTab === 'internal' ? 'bg-orange-500 shadow-orange-500/20' : 'bg-blue-600 shadow-blue-500/20'}`}><Send size={20} /></button></>)}
                                                        {isLockedForTech && activeChatTab === 'public' && !isFinalized && (<div className="w-full text-center py-3 text-xs text-slate-400 font-bold bg-slate-100 dark:bg-slate-800 rounded-2xl border dark:border-slate-700"><Lock size={12} className="inline mr-1"/> Chat exclusivo do responsável</div>)}
                                                        {isFinalized && (<div className="w-full text-center py-3 text-xs text-slate-400 font-bold bg-slate-50 dark:bg-slate-800 rounded-2xl border dark:border-slate-700"><Lock size={12} className="inline mr-1"/> Chamado encerrado</div>)}
                                                        </form>
                                                    </div>
                                                </div>
                                                )}
                                            </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                )}
                                </>
                            )}
                        </div>
                        )}
                    </main>
                    <footer className="py-8 border-t dark:border-slate-800 text-center text-slate-400 text-[10px] font-bold tracking-[0.2em] uppercase">Desenvolvido pela equipe de tecnologia da informação.</footer>
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
